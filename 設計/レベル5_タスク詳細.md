# レベル 5：変数の定義 - タスク詳細

## 概要

ユーザーはプロンプト内に変数を定義できる。
その変数には、自由に値を代入できます。
また、変数にユーザーが明示的に値を代入しなかった際には、自動的にデフォルトの値が代入されます。
そのデフォルトの値もユーザーが設定できます。

## TODO リスト

### 1. 変数記法の設計と仕様策定

- [x] 変数記法の決定
  - [x] 変数の基本記法の設計（例：`{variable}`, `{{variable}}`, `$variable`）
  - [x] 変数名の命名規則の定義（英数字、アンダースコア、日本語対応など）
  - [x] 予約語の定義と制限事項の策定
  - [x] エスケープ文字の仕様決定
- [x] デフォルト値記法の設計
  - [x] デフォルト値指定の記法（例：`{variable:default}`）
  - [x] 複数行デフォルト値の対応
  - [x] 特殊文字を含むデフォルト値の処理方法
  - [ ] 動的デフォルト値（日付、時刻など）の対応
- [ ] 高度な変数記法の検討
  - [ ] 変数の型指定（文字列、数値、真偽値など）
  - [ ] 条件分岐記法の検討（if 文的な機能）
  - [ ] 変数の入れ子構造対応の検討
  - [ ] 配列・リスト形式の変数対応の検討

### 2. 変数解析エンジンの実装

- [x] 変数パーサーの開発
  - [x] 正規表現を使用した変数検出機能
  - [x] 変数名とデフォルト値の分離処理
  - [x] ネストした変数の解析機能
  - [x] エラーハンドリング（不正な変数記法の検出）
- [x] 変数置換エンジンの実装
  - [x] 変数値による文字列置換機能
  - [x] デフォルト値の自動適用機能
  - [x] 未定義変数の検出と警告機能
  - [x] 循環参照の検出と防止機能
- [x] 変数検証機能の実装
  - [x] 変数名の妥当性チェック
  - [x] 変数値の型チェック機能
  - [x] 必須変数の未設定チェック
  - [x] 変数値の長さ制限チェック

### 3. 変数管理システムの実装

- [x] 変数データ構造の設計
  - [x] 変数メタデータの定義（名前、型、デフォルト値、説明など）
  - [x] プロンプト別変数セットの管理構造
  - [x] 変数履歴の保存構造設計
  - [x] 変数テンプレートの保存形式設計
- [x] 変数保存・読み込み機能
  - [x] 変数設定のローカルストレージ保存
  - [x] プロンプト別変数設定の管理
  - [x] 変数設定のインポート・エクスポート機能
  - [x] 変数設定のバックアップ・復元機能
- [x] 変数テンプレート機能
  - [x] よく使う変数セットのテンプレート保存
  - [x] テンプレートの適用機能
  - [x] テンプレートの共有機能の検討
  - [x] デフォルトテンプレートの提供

### 4. 変数設定 UI の実装

- [x] 変数検出・表示機能
  - [x] プロンプト内変数の自動検出表示
  - [x] 変数一覧の表示 UI
  - [x] 変数の設定状況の視覚的表示
  - [x] 未設定変数のハイライト表示
- [x] 変数値入力 UI
  - [x] 各変数の入力フィールド作成
  - [x] 変数タイプに応じた入力コントロール
  - [x] デフォルト値の表示と編集機能
  - [x] 変数説明・ヘルプテキストの表示
- [x] 変数設定パネルの実装
  - [x] サイドパネルでの変数設定 UI
  - [x] 変数設定の保存・適用ボタン
  - [x] 変数設定のリセット機能
  - [x] 変数設定のプレビュー機能

### 5. プロンプトプレビュー機能

- [x] リアルタイムプレビューの実装
  - [x] 変数置換後のプロンプト表示
  - [x] 変数値変更時の即座な更新
  - [x] プレビューのハイライト表示
  - [x] 置換前・置換後の比較表示
- [x] プレビュー UI 機能
  - [x] プレビューエリアの実装
  - [x] フォーマット表示の対応
  - [x] 長いプロンプトの折り返し表示
  - [x] プレビューの印刷・エクスポート機能
- [x] プレビューの検証機能
  - [x] 置換結果の妥当性チェック
  - [x] 文字数カウント表示
  - [x] 警告・エラーメッセージの表示
  - [x] プレビュー内容のコピー機能

### 🐛 UI 統合・バグ修正タスク（緊急）

- [x] メインパネルと変数設定パネルの統合問題の解決
  - [x] コピー・実行時の変数置換処理の統合
  - [x] 変数設定パネルの初期化タイミングの修正
  - [x] プロンプト選択時の変数解析結果の正しい表示
  - [x] 変数値入力フィールドの動作確認と修正
- [ ] 変数処理ワークフローの完全統合
  - [ ] プロンプト選択 → 変数解析 → UI 表示 → 値入力 → 置換処理の流れの確認
  - [ ] 各段階でのエラーハンドリングの確認
  - [ ] デバッグログの充実化
  - [ ] UI 状態の同期問題の解決
- [ ] テスト環境での動作確認
  - [x] 変数機能の核となる処理のテスト（完了）
  - [ ] 実際の VS Code 環境での動作テスト
  - [ ] エラーケースのテスト
  - [ ] パフォーマンステスト

### 6. 変数履歴とお気に入り機能

- [ ] 変数値履歴の管理
  - [ ] 各変数の過去の設定値履歴保存
  - [ ] 履歴からの値選択機能
  - [ ] 履歴の検索・フィルタ機能
  - [ ] 履歴の削除・クリア機能
- [ ] お気に入り変数値セット
  - [ ] 変数値の組み合わせをお気に入り保存
  - [ ] お気に入りセットの名前付け機能
  - [ ] お気に入りからの一括適用機能
  - [ ] お気に入りの編集・削除機能
- [ ] 使用統計の記録
  - [ ] 各変数の使用頻度記録
  - [ ] よく使われる変数値の統計
  - [ ] 変数使用パターンの分析
  - [ ] 統計データの表示機能

### 7. 高度な変数機能

- [ ] 変数の型システム実装
  - [ ] 文字列型変数の処理
  - [ ] 数値型変数の処理と検証
  - [ ] 真偽値型変数の処理
  - [ ] 日付・時刻型変数の処理
- [ ] 動的変数の実装
  - [ ] 現在日時を使用する変数
  - [ ] ファイル情報を使用する変数
  - [ ] 環境変数を使用する変数
  - [ ] 計算結果を使用する変数
- [ ] 変数間の依存関係処理
  - [ ] 変数の依存関係検出
  - [ ] 依存関係に基づく更新順序制御
  - [ ] 依存関係の可視化機能
  - [ ] 循環依存の検出と警告

### 8. 変数のインポート・エクスポート機能

- [ ] データ形式の対応
  - [ ] JSON 形式でのエクスポート・インポート
  - [ ] CSV 形式での変数一覧エクスポート
  - [ ] YAML 形式での設定ファイル対応
  - [ ] 既存テンプレートファイルからの変数抽出
- [ ] 外部連携機能
  - [ ] 外部ファイルからの変数値読み込み
  - [ ] データベースからの変数値取得（将来拡張）
  - [ ] API 連携による動的変数値取得（将来拡張）
  - [ ] 他のプロンプト管理ツールとの連携

### 9. エラーハンドリングとデバッグ機能

- [ ] 変数エラーの分類と対応
  - [ ] 変数記法エラーの検出と修正提案
  - [ ] 未定義変数の警告表示
  - [ ] 型不一致エラーの処理
  - [ ] 循環参照エラーの検出と解決支援
- [ ] デバッグ支援機能
  - [ ] 変数解析過程の詳細ログ出力
  - [ ] 変数置換の段階的表示機能
  - [ ] デバッグモードでの詳細情報表示
  - [ ] 変数処理のパフォーマンス測定
- [ ] ユーザー支援機能
  - [ ] 変数記法のガイド表示
  - [ ] エラーメッセージの多言語対応
  - [ ] 修正提案の自動生成
  - [ ] よくある問題の FAQ 表示

### 10. テストとドキュメント

- [ ] 単体テストの作成
  - [ ] 変数解析エンジンのテスト
  - [ ] 変数置換機能のテスト
  - [ ] UI 操作のテスト
  - [ ] エラーハンドリングのテスト
- [ ] 統合テストの実装
  - [ ] 複雑な変数パターンのテスト
  - [ ] 大量変数の処理性能テスト
  - [ ] UI 操作フローの総合テスト
  - [ ] 既存機能との連携テスト
- [ ] ドキュメントの作成
  - [ ] 変数記法の完全ガイド作成
  - [ ] 変数機能の使用例集作成
  - [ ] トラブルシューティングガイド作成
  - [ ] 開発者向け API 仕様書作成

## 完了条件

- ユーザーがプロンプト内に `{variable}` 形式で変数を定義できる
- 変数に値を設定し、プロンプト表示時に適切に置換される
- デフォルト値が未設定変数に自動適用される
- 変数設定 UI が直感的で使いやすい
- 変数値の履歴が保存され、再利用できる
- エラー時に適切なフィードバックが提供される
- 複数の変数を含む複雑なプロンプトが正しく処理される
