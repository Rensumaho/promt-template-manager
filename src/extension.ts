// The module 'vscode' contains the VS Code extensibility API
// Import the module and reference it with the alias vscode in your code below
import * as vscode from 'vscode';
import { PromptStorage } from './storage';
import { PromptData, PromptInput } from './types';
import { VariableSettingsPanel } from './ui/variableSettingsPanel';
import { PromptUtils, PromptValidator } from './validation';
import { VariableStorage } from './variableStorage';

// TreeDataProvider for Activity Bar
class PromptTemplateTreeProvider implements vscode.TreeDataProvider<PromptTreeItem> {
	private _onDidChangeTreeData: vscode.EventEmitter<PromptTreeItem | undefined | null | void> = new vscode.EventEmitter<PromptTreeItem | undefined | null | void>();
	readonly onDidChangeTreeData: vscode.Event<PromptTreeItem | undefined | null | void> = this._onDidChangeTreeData.event;

	constructor(private promptManager: PromptManager) {}

	refresh(): void {
		this._onDidChangeTreeData.fire();
	}

	getTreeItem(element: PromptTreeItem): vscode.TreeItem {
		return element;
	}

	getChildren(element?: PromptTreeItem): Thenable<PromptTreeItem[]> {
		if (!element) {
			// Root level items - Open Manager, Export, Import
			const items: PromptTreeItem[] = [
				new PromptTreeItem('üìù Open Manager', 'openManager', vscode.TreeItemCollapsibleState.None),
				new PromptTreeItem('üì§ Export Prompts', 'exportData', vscode.TreeItemCollapsibleState.None),
				new PromptTreeItem('üì• Import Prompts', 'importData', vscode.TreeItemCollapsibleState.None)
			];
			return Promise.resolve(items);
		}
		return Promise.resolve([]);
	}
}

class PromptTreeItem extends vscode.TreeItem {
	constructor(
		public readonly label: string,
		public readonly itemType: string,
		public readonly collapsibleState: vscode.TreeItemCollapsibleState,
		public readonly promptId?: string
	) {
		super(label, collapsibleState);
		
		this.contextValue = itemType;
		
		if (itemType === 'openManager') {
			this.command = {
				command: 'prompt-template-manager.openPanel',
				title: 'Open Prompt Template Manager'
			};
			this.iconPath = new vscode.ThemeIcon('window');
		} else if (itemType === 'exportData') {
			this.command = {
				command: 'prompt-template-manager.exportDataWithSelection',
				title: 'Export Selected Prompts'
			};
			this.iconPath = new vscode.ThemeIcon('export');
		} else if (itemType === 'importData') {
			this.command = {
				command: 'prompt-template-manager.importDataWithRefresh',
				title: 'Import Prompts'
			};
			this.iconPath = new vscode.ThemeIcon('import');
		}
	}
}

// „É°„Ç§„É≥„ÅÆWebview„Éë„Éç„É´„ÇØ„É©„Çπ
class PromptTemplatePanel {
	public static currentPanel: PromptTemplatePanel | undefined;
	public static readonly viewType = 'promptTemplateManager';

	private readonly _panel: vscode.WebviewPanel;
	private readonly _extensionUri: vscode.Uri;
	private _disposables: vscode.Disposable[] = [];
	private promptManager: PromptManager;
	private variableSettingsProvider?: VariableSettingsPanel;
	private fileContentMappings: Map<string, {fileName: string, content: string}> = new Map(); // Â§âÊï∞Âêç -> „Éï„Ç°„Ç§„É´ÊÉÖÂ†±

	public static createOrShow(extensionUri: vscode.Uri, promptManager: PromptManager, variableSettingsProvider?: VariableSettingsPanel) {
		const column = vscode.window.activeTextEditor
			? vscode.window.activeTextEditor.viewColumn
			: undefined;

		// „Éë„Éç„É´„ÅåÊó¢„Å´Èñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØË°®Á§∫
		if (PromptTemplatePanel.currentPanel) {
			PromptTemplatePanel.currentPanel._panel.reveal(column);
			// Â§âÊï∞Ë®≠ÂÆö„Éó„É≠„Éê„Ç§„ÉÄ„Éº„ÇíÊõ¥Êñ∞
			if (variableSettingsProvider) {
				PromptTemplatePanel.currentPanel.variableSettingsProvider = variableSettingsProvider;
			}
			return;
		}

		// Êñ∞„Åó„ÅÑ„Éë„Éç„É´„Çí‰ΩúÊàê
		const panel = vscode.window.createWebviewPanel(
			PromptTemplatePanel.viewType,
			'Prompt Template Manager',
			column || vscode.ViewColumn.One,
			{
				enableScripts: true,
				localResourceRoots: [extensionUri],
				retainContextWhenHidden: true // „Ç¶„Ç£„É≥„Éâ„Ç¶Âàá„ÇäÊõø„ÅàÊôÇ„ÅÆÁä∂ÊÖã‰øùÊåÅ„ÇíÊúâÂäπÂåñ
			}
		);

		PromptTemplatePanel.currentPanel = new PromptTemplatePanel(panel, extensionUri, promptManager, variableSettingsProvider);
	}

	private constructor(panel: vscode.WebviewPanel, extensionUri: vscode.Uri, promptManager: PromptManager, variableSettingsProvider?: VariableSettingsPanel) {
		this._panel = panel;
		this._extensionUri = extensionUri;
		this.promptManager = promptManager;
		this.variableSettingsProvider = variableSettingsProvider;

		// „Éë„Éç„É´„ÅÆHTML„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíË®≠ÂÆö
		this._update();

		// „Éë„Éç„É´„ÅåÈñâ„Åò„Çâ„Çå„ÅüÊôÇ„ÅÆ„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
		this._panel.onDidDispose(() => this.dispose(), null, this._disposables);

		// Webview„Åã„Çâ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂá¶ÁêÜ
		this._panel.webview.onDidReceiveMessage(
			async (message) => {
				await this._handleWebviewMessage(message);
			},
			null,
			this._disposables
		);

		// ÂàùÊúü„Éá„Éº„Çø„ÇíÈÄÅ‰ø°
		this._sendPromptsToWebview();
	}

	public dispose() {
		PromptTemplatePanel.currentPanel = undefined;

		// „Éë„Éç„É´„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
		this._panel.dispose();

		while (this._disposables.length) {
			const x = this._disposables.pop();
			if (x) {
				x.dispose();
			}
		}
	}

	public refresh() {
		this._sendPromptsToWebview();
	}

	private async _sendPromptsToWebview() {
		const prompts = this.promptManager.getCurrentDisplayPrompts();
		console.log(`WebView„Å´„Éó„É≠„É≥„Éó„Éà„ÇíÈÄÅ‰ø°: ${prompts.length}‰ª∂`, prompts);
		await this._panel.webview.postMessage({
			type: 'updatePrompts',
			prompts: prompts,
			selectedPromptId: this.promptManager.getSelectedPromptId(),
			isSearching: this.promptManager.isSearching()
		});
	}

	private async _handleWebviewMessage(message: any) {
		console.log('Received message:', message);
		
		switch (message.type) {
			case 'ready':
				console.log('WebViewÊ∫ñÂÇôÂÆå‰∫Ü');
				await this._sendPromptsToWebview();
				break;

			case 'promptsRequested':
				console.log('„Éó„É≠„É≥„Éó„Éà‰∏ÄË¶ß„ÅåË¶ÅÊ±Ç„Åï„Çå„Åæ„Åó„Åü');
				await this._sendPromptsToWebview();
				break;

			case 'selectPrompt':
			case 'promptSelected':
				console.log(`„Éó„É≠„É≥„Éó„Éà„ÅåÈÅ∏Êäû„Åï„Çå„Åæ„Åó„Åü: ID=${message.id}`);
				this.promptManager.setSelectedPrompt(message.id);
				
				// ÈÅ∏Êäû„Åï„Çå„Åü„Éó„É≠„É≥„Éó„Éà„Çíwebview„Å´ÈÄÅ‰ø°
				const selectedPrompt = this.promptManager.getPrompts().find(p => p.id === message.id);
				if (selectedPrompt) {
					console.log('ÈÅ∏Êäû„Åï„Çå„Åü„Éó„É≠„É≥„Éó„Éà:', selectedPrompt);
					await this._panel.webview.postMessage({
						type: 'showPromptDetail',
						prompt: selectedPrompt
					});
					
					// Â§âÊï∞Ë®≠ÂÆö„Éë„Éç„É´„Å´Â§âÊï∞Ëß£ÊûêÁµêÊûú„ÇíÈÄÅ‰ø°
					if (this.variableSettingsProvider) {
						console.log('Â§âÊï∞Ë®≠ÂÆö„Éë„Éç„É´„ÅåÂ≠òÂú®„Åó„Åæ„Åô„ÄÇÂ§âÊï∞Ëß£Êûê„ÇíÈñãÂßã...');
						console.log('Ëß£ÊûêÂØæË±°„Éó„É≠„É≥„Éó„ÉàÂÜÖÂÆπ:', selectedPrompt.content);
						
						try {
							await this.variableSettingsProvider.analyzeCurrentPrompt(message.id, selectedPrompt.content);
							console.log('Â§âÊï∞Ëß£ÊûêÂÆå‰∫Ü');
						} catch (error) {
							console.error('Â§âÊï∞Ëß£Êûê„Ç®„É©„Éº:', error);
						}
					} else {
						console.warn('Â§âÊï∞Ë®≠ÂÆö„Éë„Éç„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
					}
				} else {
					console.error(`„Éó„É≠„É≥„Éó„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ID=${message.id}`);
				}
				break;

			case 'searchPrompts':
				console.log(`„Éó„É≠„É≥„Éó„ÉàÊ§úÁ¥¢: „ÇØ„Ç®„É™="${message.query}"`);
				this.promptManager.setSearchState(message.query);
				await this._sendPromptsToWebview();
				break;

			case 'clearSearch':
				console.log('Ê§úÁ¥¢„ÇØ„É™„Ç¢');
				this.promptManager.clearSearchState();
				await this._sendPromptsToWebview();
				break;

			case 'createPrompt':
			case 'addPrompt':
				console.log('„Éó„É≠„É≥„Éó„ÉàËøΩÂä†');
				await this._createDefaultPrompt();
				break;

			case 'deletePrompt':
				console.log(`„Éó„É≠„É≥„Éó„ÉàÂâäÈô§: ID=${message.id}`);
				await this._deletePrompt(message.id);
				break;

			case 'copyPrompt':
				const copyPromptId = message.id;
				console.log(`„Éó„É≠„É≥„Éó„Éà„Ç≥„Éî„Éº: ID=${copyPromptId}`);
				
				// ‰ΩøÁî®ÂõûÊï∞„ÇíÂ¢óÂä†
				const copyIncrementSuccess = await this.promptManager.incrementUsage(copyPromptId);
				if (copyIncrementSuccess) {
					console.log(`„Ç≥„Éî„Éº‰ΩøÁî®ÂõûÊï∞Â¢óÂä†ÊàêÂäü: ID=${copyPromptId}`);
					// „Éó„É≠„É≥„Éó„Éà‰∏ÄË¶ß„ÇíÊõ¥Êñ∞Ôºà‰ΩøÁî®ÂõûÊï∞È†Ü„Å´ÂÜç„ÇΩ„Éº„ÉàÔºâ
					await this._sendPromptsToWebview();
				}
				
				// Â§âÊï∞Ë®≠ÂÆö„Éë„Éç„É´„Åã„ÇâÂ§âÊï∞ÂÄ§„ÇíÂèñÂæó„Åó„Å¶„Ç≥„Éî„Éº
				await this._copyPromptWithVariables(message.content, copyPromptId);
				break;

			case 'executePrompt':
				const executePromptId = message.promptId;
				console.log(`„Éó„É≠„É≥„Éó„ÉàÂÆüË°å: ID=${executePromptId}`);
				
				// ‰ΩøÁî®ÂõûÊï∞„ÇíÂ¢óÂä†
				if (executePromptId) {
					const executeIncrementSuccess = await this.promptManager.incrementUsage(executePromptId);
					if (executeIncrementSuccess) {
						console.log(`ÂÆüË°å‰ΩøÁî®ÂõûÊï∞Â¢óÂä†ÊàêÂäü: ID=${executePromptId}`);
						// „Éó„É≠„É≥„Éó„Éà‰∏ÄË¶ß„ÇíÊõ¥Êñ∞Ôºà‰ΩøÁî®ÂõûÊï∞È†Ü„Å´ÂÜç„ÇΩ„Éº„ÉàÔºâ
						await this._sendPromptsToWebview();
					}
				}
				
				// Â§âÊï∞Ë®≠ÂÆö„Éë„Éç„É´„Åã„ÇâÂ§âÊï∞ÂÄ§„ÇíÂèñÂæó„Åó„Å¶ÂÆüË°å
				await this._executePromptWithVariables(message.content, executePromptId);
				break;

			case 'updatePrompt':
				await this._updatePrompt(message.id, message.updates);
				break;

			case 'fileContentLoaded':
				console.log(`„Éï„Ç°„Ç§„É´ÂÜÖÂÆπË™≠„ÅøËæº„Åø: ${message.fileName} -> Â§âÊï∞: ${message.variableName}`);
				this._handleFileContentLoaded(message.fileName, message.variableName, message.content);
				break;

			case 'selectFileForVariable':
				console.log(`„Éï„Ç°„Ç§„É´ÈÅ∏ÊäûË¶ÅÊ±Ç: Â§âÊï∞ ${message.variableName}`);
				await this._handleFileSelection(message.variableName);
				break;

			default:
				console.warn('Unknown message type:', message.type);
		}
	}

	private _generateUniqueTitle(baseTitle: string): string {
		const existingPrompts = this.promptManager.getPrompts();
		const existingTitles = existingPrompts.map(p => p.title.toLowerCase());
		
		let title = baseTitle;
		let counter = 1;
		
		while (existingTitles.includes(title.toLowerCase())) {
			title = `${baseTitle} ${counter}`;
			counter++;
		}
		
		return title;
	}

	private async _createDefaultPrompt() {
		console.log('Êñ∞„Åó„ÅÑ„Éó„É≠„É≥„Éó„Éà„ÇíËá™Âãï‰ΩúÊàê');
		
		// „Éá„Éï„Ç©„É´„Éà„ÅÆ„Çø„Ç§„Éà„É´„Å®„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅßËá™Âãï‰ΩúÊàêÔºàÈáçË§á„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´„É¶„Éã„Éº„ÇØ„Å™„Çø„Ç§„Éà„É´„ÇíÁîüÊàêÔºâ
		const baseTitle = 'title';
		const title = this._generateUniqueTitle(baseTitle);
		const content = '';

		console.log(`„Éó„É≠„É≥„Éó„Éà‰ΩúÊàê‰∏≠: „Çø„Ç§„Éà„É´="${title}", ÂÜÖÂÆπ="${content}"`);
		const result = await this.promptManager.addPrompt({
			title,
			content
		});

		if (result) {
			console.log('„Éó„É≠„É≥„Éó„Éà‰ΩúÊàêÊàêÂäü:', result);
			// Êñ∞Ë¶è‰ΩúÊàê„Åó„Åü„Éó„É≠„É≥„Éó„Éà„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´
			this.promptManager.setSelectedPrompt(result.id);
			// Ê§úÁ¥¢Áä∂ÊÖã„Çí„ÇØ„É™„Ç¢ÔºàÊñ∞Ë¶è‰ΩúÊàêÊôÇ„ÅØÂÖ®„Éó„É≠„É≥„Éó„ÉàË°®Á§∫Ôºâ
			this.promptManager.clearSearchState();
			await this._sendPromptsToWebview();
			
			// Êñ∞Ë¶è‰ΩúÊàê„Åó„Åü„Éó„É≠„É≥„Éó„Éà„ÅÆË©≥Á¥∞„ÇíË°®Á§∫
			await this._panel.webview.postMessage({
				type: 'showPromptDetail',
				prompt: result
			});
		} else {
			console.error('„Éó„É≠„É≥„Éó„Éà‰ΩúÊàêÂ§±Êïó - addPrompt„É°„ÇΩ„ÉÉ„Éâ„Åånull„ÇíËøî„Åó„Åæ„Åó„Åü');
		}
	}



	private _handleFileContentLoaded(fileName: string, variableName: string, content: string) {
		console.log(`„Éï„Ç°„Ç§„É´ÂÜÖÂÆπ„Ç≠„É£„ÉÉ„Ç∑„É•: ${variableName} -> ${fileName} (${content.length}ÊñáÂ≠ó)`);
		
		// „Éï„Ç°„Ç§„É´ÂÜÖÂÆπ„Çí„Éû„ÉÉ„Éî„É≥„Ç∞„Å´‰øùÂ≠ò
		this.fileContentMappings.set(variableName, {
			fileName: fileName,
			content: content
		});
	}

	private async _handleFileSelection(variableName: string) {
		try {
			const fileUris = await vscode.window.showOpenDialog({
				canSelectMany: false,
				openLabel: '„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû',
				filters: {
					'„Åô„Åπ„Å¶„ÅÆ„Éï„Ç°„Ç§„É´': ['*'],
					'„ÉÜ„Ç≠„Çπ„Éà„Éï„Ç°„Ç§„É´': ['txt', 'md', 'json', 'js', 'ts', 'py', 'java', 'cpp', 'c', 'h'],
					'Ë®≠ÂÆö„Éï„Ç°„Ç§„É´': ['json', 'yaml', 'yml', 'xml', 'toml'],
					'„Éâ„Ç≠„É•„É°„É≥„Éà': ['md', 'txt', 'doc', 'docx', 'pdf']
				}
			});

			if (fileUris && fileUris.length > 0) {
				const fileUri = fileUris[0];
				
				// „Éï„Ç°„Ç§„É´ÂÜÖÂÆπ„ÇíË™≠„ÅøËæº„Åø
				const document = await vscode.workspace.openTextDocument(fileUri);
				const content = document.getText();
				
				// „Éë„Çπ„ÇíÂèñÂæóÔºà„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂÜÖÂ§ñ„ÅßÂà§ÂÆöÔºâ
				const workspaceFolder = vscode.workspace.getWorkspaceFolder(fileUri);
				let fileName: string;
				let isInWorkspace = false;
				
				if (workspaceFolder) {
					// „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂÜÖ„ÅÆÂ†¥ÂêàÔºöÁõ∏ÂØæ„Éë„Çπ„Çí‰ΩøÁî®
					fileName = vscode.workspace.asRelativePath(fileUri, false);
					isInWorkspace = true;
					console.log(`„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂÜÖ„Éï„Ç°„Ç§„É´: ${fileName}`);
				} else {
					// „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂ§ñ„ÅÆÂ†¥ÂêàÔºöÁµ∂ÂØæ„Éë„Çπ„Çí‰ΩøÁî®
					fileName = fileUri.fsPath;
					isInWorkspace = false;
					console.log(`„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂ§ñ„Éï„Ç°„Ç§„É´: ${fileName}`);
				}
				
				// „Éï„Ç°„Ç§„É´ÂÜÖÂÆπ„Çí„Ç≠„É£„ÉÉ„Ç∑„É•Ôºà„Éï„É´„Éë„Çπ„Åß‰øùÂ≠òÔºâ
				this.fileContentMappings.set(variableName, {
					fileName: fileUri.fsPath, // Áµ∂ÂØæ„Éë„Çπ„Åß‰øùÂ≠ò
					content: content
				});
				
				// WebView „Å´ÁµêÊûú„ÇíÈÄÅ‰ø°
				await this._panel.webview.postMessage({
					type: 'fileSelected',
					variableName: variableName,
					fileName: fileName
				});
				
				console.log(`„Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÂÆå‰∫Ü: ${variableName} -> ${fileName} (‰øùÂ≠ò„Éë„Çπ: ${fileUri.fsPath})`);
			}
		} catch (error) {
			console.error('„Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Ç®„É©„Éº:', error);
			vscode.window.showErrorMessage(`„Éï„Ç°„Ç§„É´ÈÅ∏Êäû‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ${error}`);
		}
	}



	private async _deletePrompt(id: string) {
		const prompt = this.promptManager.getPrompts().find(p => p.id === id);
		if (!prompt) return;

		// ÂâäÈô§ÂØæË±°„ÅåÈÅ∏Êäû‰∏≠„ÅÆ„Éó„É≠„É≥„Éó„Éà„Åã„Å©„ÅÜ„Åã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
		const wasSelected = this.promptManager.isSelectedPrompt(id);

		// Á¢∫Ë™ç„Å™„Åó„ÅßÂâäÈô§
		const success = await this.promptManager.deletePrompt(id);
		if (success) {
			// ÈÅ∏Êäû‰∏≠„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÅåÂâäÈô§„Åï„Çå„ÅüÂ†¥Âêà„ÅØÈÅ∏Êäû„Çí„ÇØ„É™„Ç¢
			if (wasSelected) {
				this.promptManager.setSelectedPrompt(null);
				// Ë©≥Á¥∞„Éë„Éç„É´„Çí„ÇØ„É™„Ç¢
				await this._panel.webview.postMessage({
					type: 'clearPromptDetail'
				});
			}
			await this._sendPromptsToWebview();
		}
	}

	private async _copyPromptToClipboard(content: string) {
		await vscode.env.clipboard.writeText(content);
	}

	private async _replaceVariablesWithFileContent(content: string, variablePattern: RegExp, variableValues: Record<string, string>): Promise<string> {
		let replacedContent = content;
		const matches: Array<{match: string, variableName: string, defaultValue: string, value: string}> = [];
		
		// „Åæ„ÅöÂÖ®„Å¶„ÅÆÂ§âÊï∞„Éû„ÉÉ„ÉÅ„ÇíÂèéÈõÜ
		let match;
		while ((match = variablePattern.exec(content)) !== null) {
			const fullContent = match[1];
			const separatorIndex = fullContent.indexOf(':');
			const variableName = separatorIndex === -1 ? fullContent : fullContent.substring(0, separatorIndex);
			const defaultValue = separatorIndex === -1 ? '' : fullContent.substring(separatorIndex + 1);
			
			// Â§âÊï∞ÂÄ§„ÇíÂèñÂæóÔºà„É¶„Éº„Ç∂„ÉºÂÖ•Âäõ > „Éá„Éï„Ç©„É´„ÉàÂÄ§ > Á©∫ÊñáÂ≠óÔºâ
			const value = variableValues[variableName] || defaultValue || '';
			
			matches.push({
				match: match[0],
				variableName,
				defaultValue,
				value
			});
		}
		
		// ÂêÑÂ§âÊï∞„ÇíÂá¶ÁêÜ
		for (const matchInfo of matches) {
			console.log(`Â§âÊï∞ÁΩÆÊèõ: ${matchInfo.variableName} ‚Üí "${matchInfo.value}"`);
			
			// @filename„Éë„Çø„Éº„É≥„Çí„ÉÅ„Çß„ÉÉ„ÇØ
			if (matchInfo.value.startsWith('@')) {
				const fileName = matchInfo.value.substring(1); // @„ÇíÈô§Âéª
				try {
					const fileContent = await this._readFileContent(fileName, matchInfo.variableName);
					
									// „Éï„Ç°„Ç§„É´„Éë„Çπ„ÇíÂèñÂæóÔºà„Éû„ÉÉ„Éî„É≥„Ç∞„Åæ„Åü„ÅØÊ§úÁ¥¢ÁµêÊûú„Åã„ÇâÔºâ
				const fileInfo = this.fileContentMappings.get(matchInfo.variableName);
				let filePath = fileInfo?.fileName || fileName;
				
				// „Éë„Çπ„ÅÆË°®Á§∫ÂΩ¢Âºè„ÇíÊ±∫ÂÆöÔºà„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂÜÖÂ§ñ„ÅßÂà§ÂÆöÔºâ
				let displayPath: string;
				try {
					const fileUri = vscode.Uri.file(filePath);
					const workspaceFolder = vscode.workspace.getWorkspaceFolder(fileUri);
					
					if (workspaceFolder) {
						// „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂÜÖ„ÅÆÂ†¥ÂêàÔºö„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„ÇπÂêç/Áõ∏ÂØæ„Éë„Çπ
						const relativePath = vscode.workspace.asRelativePath(fileUri, false);
						const workspaceName = workspaceFolder.name;
						displayPath = `${workspaceName}/${relativePath}`;
					} else {
						// „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂ§ñ„ÅÆÂ†¥ÂêàÔºöÁµ∂ÂØæ„Éë„Çπ„Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®
						displayPath = filePath.replace(/\\/g, '/'); // Windows„ÅÆ„Éë„ÇπÂå∫Âàá„Çä„ÇíÁµ±‰∏Ä
					}
				} catch (error) {
					// „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºà„Éï„Ç°„Ç§„É´Âêç„ÅÆ„ÅøÔºâ
					displayPath = filePath.split(/[/\\]/).pop() || filePath;
				}
				
				const formattedContent = `\n<additional_data>\nBelow are some potentially helphul/relevant pieces of information for figuring out to respond\n<attached_files>\n<file_contents>\n\`\`\`path=${displayPath}\n${fileContent}\n\`\`\`\n</file_contents>\n</attached_files>\n</additional_data>\n`;
				replacedContent = replacedContent.replace(matchInfo.match, formattedContent);
				} catch (error) {
					console.error(`„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº: ${fileName}`, error);
					// „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØÂÖÉ„ÅÆÂÄ§„Çí„Åù„ÅÆ„Åæ„Åæ‰ΩøÁî®
					replacedContent = replacedContent.replace(matchInfo.match, matchInfo.value);
				}
			} else {
				// ÈÄöÂ∏∏„ÅÆÂ§âÊï∞ÁΩÆÊèõ
				replacedContent = replacedContent.replace(matchInfo.match, matchInfo.value);
			}
		}
		
		return replacedContent;
	}

	private async _readFileContent(fileName: string, variableName?: string): Promise<string> {
		// „ÉØ„Éº„ÇØ„Çπ„Éö„Éº„ÇπÂÜÖ„Åß„Éï„Ç°„Ç§„É´„ÇíÊ§úÁ¥¢
		const workspaceFolders = vscode.workspace.workspaceFolders;
		if (!workspaceFolders || workspaceFolders.length === 0) {
			throw new Error('„ÉØ„Éº„ÇØ„Çπ„Éö„Éº„Çπ„ÅåÈñã„Åã„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
		}
		
		let filePath: string | undefined;
		
		// Â§âÊï∞Âêç„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Å¶„ÄÅ„Éï„Ç°„Ç§„É´ÂÜÖÂÆπ„Éû„ÉÉ„Éî„É≥„Ç∞„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®
		if (variableName && this.fileContentMappings.has(variableName)) {
			const fileInfo = this.fileContentMappings.get(variableName);
			if (fileInfo) {
				console.log(`„Éï„Ç°„Ç§„É´ÂÜÖÂÆπ„Ç≠„É£„ÉÉ„Ç∑„É•„Çí‰ΩøÁî®: ${variableName} -> ${fileInfo.fileName}`);
				return fileInfo.content;
			}
		}
		
		let fileUri: vscode.Uri;
		
		if (filePath) {
			// „Éû„ÉÉ„Éî„É≥„Ç∞„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„Éë„Çπ„Çí‰ΩøÁî®
			fileUri = vscode.Uri.joinPath(workspaceFolders[0].uri, filePath);
			
			// „Éï„Ç°„Ç§„É´„ÅÆÂ≠òÂú®Á¢∫Ë™ç
			try {
				await vscode.workspace.fs.stat(fileUri);
			} catch (error) {
				throw new Error(`„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${filePath}`);
			}
		} else {
			// „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Éï„Ç°„Ç§„É´Âêç„ÅßÊ§úÁ¥¢
			console.log(`„Éï„Ç°„Ç§„É´„Éë„Çπ„Éû„ÉÉ„Éî„É≥„Ç∞„Åå„Å™„ÅÑ„Åü„ÇÅÊ§úÁ¥¢: ${fileName}`);
			const files = await vscode.workspace.findFiles(`**/${fileName}`, '**/node_modules/**', 1);
			
			if (files.length === 0) {
				throw new Error(`„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${fileName}`);
			}
			
			fileUri = files[0];
		}
		
		// „Éï„Ç°„Ç§„É´ÂÜÖÂÆπ„ÇíË™≠„ÅøËæº„Åø
		const document = await vscode.workspace.openTextDocument(fileUri);
		return document.getText();
	}

	private async _copyPromptWithVariables(content: string, promptId: string) {
		console.log('=== _copyPromptWithVariablesÈñãÂßã ===');
		console.log('„Ç≥„Éî„ÉºÂØæË±°„Éó„É≠„É≥„Éó„ÉàÂÜÖÂÆπ:', content);
		console.log('„Éó„É≠„É≥„Éó„ÉàID:', promptId);
		
		// WebView„Åã„ÇâÂ§âÊï∞ÂÄ§„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
		const getVariableValuesFromWebview = (): Promise<Record<string, string>> => {
			return new Promise((resolve) => {
				// WebView„Å´Â§âÊï∞ÂÄ§„ÇíË¶ÅÊ±Ç
				this._panel.webview.postMessage({ type: 'getVariableValues' });
				
				// ‰∏ÄÂ∫¶„Å†„Åë„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèó‰ø°„Åô„Çã„Åü„ÇÅ„ÅÆ„É™„Çπ„Éä„Éº
				const disposable = this._panel.webview.onDidReceiveMessage(message => {
					if (message.type === 'variableValues') {
						disposable.dispose();
						resolve(message.values || {});
					}
				});
				
				// „Çø„Ç§„É†„Ç¢„Ç¶„ÉàÂá¶ÁêÜÔºà3ÁßíÂæåÔºâ
				setTimeout(() => {
					disposable.dispose();
					resolve({});
				}, 3000);
			});
		};
		
		try {
			const variableValues = await getVariableValuesFromWebview();
			console.log('WebView„Åã„ÇâÂèñÂæó„Åó„ÅüÂ§âÊï∞ÂÄ§:', variableValues);
			
			// Á∞°ÊòìÁöÑ„Å™Â§âÊï∞ÁΩÆÊèõÂá¶ÁêÜ
			let replacedContent = content;
			
			// Êó•Êú¨Ë™ûÂØæÂøú„ÅÆÂ§âÊï∞„Éë„Çø„Éº„É≥
			const variablePattern = /\{([\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\u3400-\u4DBF]+(?::[^}]*)?)\}/g;
			
			replacedContent = await this._replaceVariablesWithFileContent(content, variablePattern, variableValues);
			
			console.log('ÁΩÆÊèõÂæå„ÅÆÂÜÖÂÆπ:', replacedContent);
			await this._copyPromptToClipboard(replacedContent);
			console.log('=== _copyPromptWithVariablesÂÆå‰∫Ü ===');
		} catch (error) {
			console.error('=== _copyPromptWithVariables „Ç®„É©„Éº ===');
			console.error('Â§âÊï∞Âá¶ÁêÜ„Ç®„É©„Éº:', error);
			console.log('ÂÖÉ„ÅÆ„Éó„É≠„É≥„Éó„Éà„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åô:', content);
			await this._copyPromptToClipboard(content);
		}
	}

	private async _executePrompt(content: string) {
		// „Åì„Åì„ÅßÂÆüÈöõ„ÅÆAI„ÉÅ„É£„ÉÉ„ÉàÂÖ•ÂäõÊ¨Ñ„Å∏„ÅÆÊåøÂÖ•Âá¶ÁêÜ„ÇíÂÆüË£Ö
		await vscode.env.clipboard.writeText(content);
	}

	private async _executePromptWithVariables(content: string, promptId: string | undefined) {
		console.log('=== _executePromptWithVariablesÈñãÂßã ===');
		console.log('ÂÆüË°åÂØæË±°„Éó„É≠„É≥„Éó„ÉàÂÜÖÂÆπ:', content);
		console.log('„Éó„É≠„É≥„Éó„ÉàID:', promptId);
		
		// WebView„Åã„ÇâÂ§âÊï∞ÂÄ§„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
		const getVariableValuesFromWebview = (): Promise<Record<string, string>> => {
			return new Promise((resolve) => {
				// WebView„Å´Â§âÊï∞ÂÄ§„ÇíË¶ÅÊ±Ç
				this._panel.webview.postMessage({ type: 'getVariableValues' });
				
				// ‰∏ÄÂ∫¶„Å†„Åë„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèó‰ø°„Åô„Çã„Åü„ÇÅ„ÅÆ„É™„Çπ„Éä„Éº
				const disposable = this._panel.webview.onDidReceiveMessage(message => {
					if (message.type === 'variableValues') {
						disposable.dispose();
						resolve(message.values || {});
					}
				});
				
				// „Çø„Ç§„É†„Ç¢„Ç¶„ÉàÂá¶ÁêÜÔºà3ÁßíÂæåÔºâ
				setTimeout(() => {
					disposable.dispose();
					resolve({});
				}, 3000);
			});
		};
		
		try {
			const variableValues = await getVariableValuesFromWebview();
			console.log('WebView„Åã„ÇâÂèñÂæó„Åó„ÅüÂ§âÊï∞ÂÄ§:', variableValues);
			
			// Êó•Êú¨Ë™ûÂØæÂøú„ÅÆÂ§âÊï∞„Éë„Çø„Éº„É≥
			const variablePattern = /\{([\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\u3400-\u4DBF]+(?::[^}]*)?)\}/g;
			
			const replacedContent = await this._replaceVariablesWithFileContent(content, variablePattern, variableValues);
			
			console.log('ÁΩÆÊèõÂæå„ÅÆÂÜÖÂÆπ:', replacedContent);
			await vscode.env.clipboard.writeText(replacedContent);
			console.log('=== _executePromptWithVariablesÂÆå‰∫Ü ===');
		} catch (error) {
			console.error('=== _executePromptWithVariables „Ç®„É©„Éº ===');
			console.error('Â§âÊï∞Âá¶ÁêÜ„Ç®„É©„Éº:', error);
			console.log('ÂÖÉ„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíÂÆüË°å„Åó„Åæ„Åô:', content);
			await vscode.env.clipboard.writeText(content);
		}
	}

	private async _updatePrompt(id: string, updates: any) {
		const success = await this.promptManager.updatePrompt(id, updates);
		if (success) {
			await this._sendPromptsToWebview();
			
			// Êõ¥Êñ∞„Åï„Çå„Åü„Éó„É≠„É≥„Éó„Éà„ÅÆË©≥Á¥∞„ÇíÂÜçË°®Á§∫
			const updatedPrompt = this.promptManager.getPrompts().find(p => p.id === id);
			if (updatedPrompt) {
				await this._panel.webview.postMessage({
					type: 'showPromptDetail',
					prompt: updatedPrompt
				});
			}
		}
	}

	private _update() {
		this._panel.webview.html = this._getHtmlForWebview();
	}

	private _getHtmlForWebview(): string {
		return `<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Prompt Template Manager</title>
	<style>
		* {
			box-sizing: border-box;
		}
		
		body { 
			font-family: var(--vscode-font-family);
			color: var(--vscode-foreground);
			background-color: var(--vscode-editor-background);
			margin: 0;
			padding: 0;
			font-size: var(--vscode-font-size);
		}
		
		.container {
			display: flex;
			height: calc(100vh - 40px);
			gap: 1px;
			min-height: 400px;
			flex-direction: row; /* „Éá„Éï„Ç©„É´„Éà„ÅØÊ®™‰∏¶„Å≥ */
		}


		
		.panel {
			border: 1px solid var(--vscode-panel-border);
			background: var(--vscode-editor-background);
		}
		
		.search-panel {
			flex: 0 0 280px;
			padding: 16px;
			overflow: hidden;
			height: 100%;
			display: flex;
			flex-direction: column;
		}
		
		.detail-panel {
			flex: 1;
			padding: 16px;
			overflow-y: auto;
			height: 100%;
			display: flex;
			flex-direction: column;
		}
		
		.prompt-detail-section {
			flex: 3;
			overflow-y: auto;
			margin-bottom: 16px;
		}
		
		.variable-section {
			flex: 2;
			overflow-y: auto;
			border-top: 1px solid var(--vscode-panel-border);
			padding-top: 16px;
		}
		
		.search-header {
			flex: none;
			margin-bottom: 12px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		/* ÈùûË°®Á§∫ÊôÇ„ÅÆ„Éò„ÉÉ„ÉÄ„Éº‰∏≠Â§ÆÂØÑ„Åõ */
		.container.search-hidden .search-header,
		.container.detail-hidden .search-header,
		.container.variable-hidden .variable-header {
			justify-content: center;
		}
		
		.add-button {
			width: 100%;
			background: var(--vscode-button-background);
			color: var(--vscode-button-foreground);
			border: none;
			padding: 10px 16px;
			border-radius: 4px;
			cursor: pointer;
			margin-bottom: 12px;
			font-size: 13px;
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
		}
		
		.add-button:hover {
			background: var(--vscode-button-hoverBackground);
		}
		
		.search-box {
			width: 100%;
			padding: 8px 12px;
			background: var(--vscode-input-background);
			color: var(--vscode-input-foreground);
			border: 1px solid var(--vscode-input-border);
			border-radius: 4px;
			font-size: 13px;
		}
		
		.search-box:focus {
			border-color: var(--vscode-focusBorder);
			outline: none;
		}
		
		.prompt-list {
			flex: 1;
			overflow-y: auto;
			margin-top: 12px;
		}
		
		.prompt-item {
			background: var(--vscode-list-inactiveSelectionBackground);
			border: 1px solid var(--vscode-panel-border);
			border-radius: 6px;
			padding: 12px;
			margin-bottom: 8px;
			cursor: pointer;
			transition: all 0.2s ease;
			position: relative;
		}
		
		.prompt-item:hover {
			background: var(--vscode-list-hoverBackground);
			border-color: var(--vscode-list-hoverForeground);
		}
		
		.prompt-item.selected {
			background: var(--vscode-list-activeSelectionBackground);
			border-color: var(--vscode-focusBorder);
			color: var(--vscode-list-activeSelectionForeground);
			box-shadow: 0 0 0 1px var(--vscode-focusBorder);
		}
		
		.prompt-title {
			font-weight: bold;
			font-size: 14px;
			margin-bottom: 4px;
			color: var(--vscode-foreground);
		}
		
		.prompt-summary {
			font-size: 12px;
			color: var(--vscode-descriptionForeground);
			margin-bottom: 6px;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}
		
		.prompt-meta {
			display: flex;
			justify-content: flex-start;
			align-items: center;
			font-size: 11px;
			color: var(--vscode-descriptionForeground);
		}
		
		.usage-count {
			background: var(--vscode-badge-background);
			color: var(--vscode-badge-foreground);
			padding: 2px 6px;
			border-radius: 10px;
		}
		
		.favorite-icon {
			color: #FFD700;
		}
		
		.tags {
			display: flex;
			flex-wrap: wrap;
			gap: 4px;
			margin-top: 6px;
		}
		
		.tag {
			background: var(--vscode-button-secondaryBackground);
			color: var(--vscode-button-secondaryForeground);
			padding: 2px 6px;
			border-radius: 3px;
			font-size: 10px;
		}
		
		.detail-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 16px;
			padding-bottom: 12px;
			border-bottom: 1px solid var(--vscode-panel-border);
		}
		
		.detail-title {
			font-size: 18px;
			font-weight: bold;
			margin: 0;
			color: var(--vscode-foreground);
		}
		
		.detail-actions {
			display: flex;
			gap: 8px;
		}
		
		.action-button {
			background: none;
			color: var(--vscode-foreground);
			border: none;
			padding: 6px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px;
			min-width: 32px;
			height: 32px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.action-button.undecided {
			display: none;
		}
		
		.action-button:hover {
			background: var(--vscode-button-secondaryHoverBackground);
		}
		
		.action-button:active {
			background: var(--vscode-button-background);
			transform: scale(0.95);
			transition: all 0.1s ease;
		}
		
		.action-button.clicked {
			background: var(--vscode-button-background);
			color: var(--vscode-button-foreground);
			transform: scale(0.9);
			transition: all 0.15s ease;
		}
		
		.detail-content {
			background: var(--vscode-textCodeBlock-background);
			border: 1px solid var(--vscode-panel-border);
			border-radius: 4px;
			padding: 16px;
			margin-bottom: 16px;
			font-family: var(--vscode-editor-font-family);
			font-size: 13px;
			line-height: 1.5;
			white-space: pre-wrap;
			word-wrap: break-word;
			position: relative;
		}

		.detail-content.empty::before {
			content: "Enter the prompt and define the variables like this:{variable:default-value}\\A example: Hello, {name:world} !";
			color: var(--vscode-descriptionForeground);
			opacity: 0.7;
			pointer-events: none;
			white-space: pre-line;
		}

		.detail-content:not(.empty)::before {
			display: none;
		}
		
		.editable {
			cursor: pointer;
			border: 1px solid transparent;
			border-radius: 3px;
			padding: 4px;
			transition: all 0.2s ease;
		}
		
		.editable:hover {
			background-color: var(--vscode-list-hoverBackground);
			border-color: var(--vscode-input-border);
		}
		
		.editing {
			background-color: var(--vscode-input-background);
			border-color: var(--vscode-focusBorder);
			cursor: text;
		}
		
		.edit-input {
			width: 100%;
			background: var(--vscode-input-background);
			color: var(--vscode-input-foreground);
			border: 1px solid var(--vscode-focusBorder);
			border-radius: 3px;
			padding: 4px 8px;
			font-size: inherit;
			font-family: inherit;
			resize: none;
			outline: none;
		}
		
		.edit-textarea {
			min-height: 100px;
			font-family: var(--vscode-editor-font-family);
		}
		
		.variable-highlight {
			color: var(--vscode-editor-foreground);
			padding: 2px 4px;
			border-radius: 3px;
			border: 1px solid var(--vscode-focusBorder);
			font-weight: bold;
		}
		
		.file-default-highlight {
			color: var(--vscode-editor-foreground);
			padding: 2px 4px;
			border-radius: 3px;
			font-weight: bold;
		}
		
		.detail-meta {
			display: flex;
			gap: 12px;
			font-size: 12px;
			color: var(--vscode-descriptionForeground);
		}
		
		.meta-item {
			display: flex;
		}
		
		.variable-header {
			flex: none;
			margin-bottom: 12px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		
		.variable-title {
		    display:none;
			font-size: 16px;
			font-weight: bold;
			margin: 0 0 8px 0;
			color: var(--vscode-foreground);
		}
		
		.variable-list {
			margin-bottom: 16px;
		}
		
		.variable-item {
			margin-bottom: 12px;
		}
		
		.variable-label {
			display: block;
			font-size: 12px;
			font-weight: bold;
			margin-bottom: 4px;
			color: var(--vscode-foreground);
		}
		
		.variable-input-container {
			display: flex;
			gap: 4px;
			align-items: center;
		}

		.variable-input {
			flex: 1;
			padding: 6px 8px;
			background: var(--vscode-input-background);
			color: var(--vscode-input-foreground);
			border: 1px solid var(--vscode-input-border);
			border-radius: 3px;
			font-size: 12px;
		}
		
		.variable-input:focus {
			border-color: var(--vscode-focusBorder);
			outline: none;
		}

		.file-select-button {
			padding: 6px 8px;
			background: var(--vscode-button-secondaryBackground);
			color: var(--vscode-button-secondaryForeground);
			border: 1px solid var(--vscode-button-border);
			border-radius: 3px;
			cursor: pointer;
			font-size: 12px;
			min-width: 32px;
			height: 32px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.file-select-button:hover {
			background: var(--vscode-button-secondaryHoverBackground);
		}

		.set-default-button {
			padding: 6px 8px;
			background: var(--vscode-button-secondaryBackground);
			color: var(--vscode-button-secondaryForeground);
			border: 1px solid var(--vscode-button-border);
			border-radius: 3px;
			cursor: pointer;
			font-size: 12px;
			min-width: 32px;
			height: 32px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.set-default-button:hover {
			background: var(--vscode-button-secondaryHoverBackground);
		}


		
		.execute-button {
			width: 100%;
			background: var(--vscode-button-background);
			color: var(--vscode-button-foreground);
			border: none;
			padding: 10px 16px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 13px;
			font-weight: bold;
		}
		
		.execute-button:hover {
			background: var(--vscode-button-hoverBackground);
		}
		
		.execute-button:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}
		
		.empty-state {
		    display: none;
			text-align: center;
			padding: 40px 20px;
			color: var(--vscode-descriptionForeground);
		}
		
		.empty-icon {
			font-size: 48px;
			margin-bottom: 16px;
		}
		
		.scrollbar {
			scrollbar-width: thin;
			scrollbar-color: var(--vscode-scrollbarSlider-background) transparent;
		}
		
		.scrollbar::-webkit-scrollbar {
			width: 8px;
		}
		
		.scrollbar::-webkit-scrollbar-track {
			background: transparent;
		}
		
		.scrollbar::-webkit-scrollbar-thumb {
			background-color: var(--vscode-scrollbarSlider-background);
			border-radius: 4px;
		}
		
		.scrollbar::-webkit-scrollbar-thumb:hover {
			background-color: var(--vscode-scrollbarSlider-hoverBackground);
		}



		/* ÈÄöÁü• */
		.notification {
			position: fixed;
			top: 20px;
			right: 20px;
			background: var(--vscode-notifications-background);
			border: 1px solid var(--vscode-notifications-border);
			color: var(--vscode-notifications-foreground);
			padding: 12px 16px;
			border-radius: 4px;
			min-width: 200px;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
			z-index: 2000;
			transform: translateX(100%);
			transition: transform 0.3s ease;
		}

		.notification.show {
			transform: translateX(0);
		}

		.notification-success {
			border-left: 4px solid #4CAF50;
		}

		.notification-error {
			border-left: 4px solid #f44336;
		}

		.notification-warning {
			border-left: 4px solid #ff9800;
		}

		.notification-info {
			border-left: 4px solid #2196F3;
		}

		/* „Éë„Éç„É´Âàá„ÇäÊõø„Åà„Éú„Çø„É≥ */
		.panel-toggle-btn {
			background: var(--vscode-button-secondaryBackground);
			color: var(--vscode-button-secondaryForeground);
			border: none;
			padding: 4px 8px;
			border-radius: 3px;
			cursor: pointer;
			font-size: 11px;
			min-width: 24px;
			height: 24px;
			display: none;
			align-items: center;
			justify-content: center;
		}

		.panel-toggle-btn:hover {
			background: var(--vscode-button-secondaryHoverBackground);
		}

		.panel-header-title {
			flex: 1;
			margin: 0;
			font-size: 14px;
			font-weight: bold;
			color: var(--vscode-foreground);
			display: none;
		}

		/* ÈùûË°®Á§∫Áä∂ÊÖã„ÅÆ„Éë„Éç„É´ */
		.panel.hidden {
			display: none !important;
		}

		/* „Éë„Éç„É´„ÅåÈùûË°®Á§∫„ÅÆÊôÇ„ÅÆ„É¨„Ç§„Ç¢„Ç¶„ÉàË™øÊï¥ */
		.container.search-hidden .search-panel {
			flex: 0 0 auto;
			width: 50px;
		}

		.container.search-hidden .search-content,
		.container.search-hidden .prompt-list {
			display: none;
		}

		.container.search-hidden .panel-header-title {
			display: none;
		}

		.container.detail-hidden .detail-panel {
			flex: 0 0 auto;
			width: 50px;
		}

		.container.detail-hidden #promptDetail {
			display: none;
		}

		.container.detail-hidden .panel-header-title {
			display: none;
		}




			.search-panel.collapsed {
				display: block !important;
				flex: 0 0 auto !important;
				height: 35vh !important;
				width: 100% !important;
				overflow: visible !important;
			}
		}

		/* Ê•µË∂ÖÊ•µÂ∞èÁîªÈù¢Ôºà250px‰ª•‰∏ãÔºâÔºöÊúÄÂ∞èÊ©üËÉΩË°®Á§∫ */
		@media screen and (max-width: 250px) {
			.container {
				flex-direction: column !important;
				height: 100vh !important;
				display: flex !important;
			}
			
			.search-panel {
				flex: 1 !important;
				width: 100% !important;
				min-height: 20vh;
				max-height: 30vh;
				padding: 4px;
			}
			
			.detail-panel {
				flex: 2 !important;
				width: 100% !important;
				min-height: 40vh;
				padding: 4px;
			}
			

			
			.add-button {
				font-size: 10px;
				padding: 6px 8px;
				margin-bottom: 4px;
				width: 100%;
			}
			
			.search-box {
				font-size: 11px;
				padding: 4px 6px;
				width: 100%;
			}
			
			.prompt-item {
				padding: 2px;
				margin-bottom: 1px;
			}
			
			.prompt-title {
				font-size: 9px;
			}
			
			.prompt-summary {
				font-size: 8px;
			}
			
			.detail-title {
				font-size: 10px;
			}
			
			.detail-content {
				padding: 2px;
				font-size: 8px;
			}
			
			.execute-button {
				font-size: 12px;
				padding: 8px 12px;
				width: 100%;
			}
			
			.prompt-list {
				height: calc(100% - 60px);
				max-height: none;
			}
			
			.panel-toggle {
				display: none !important;
			}
		}

		/* Ê®™ÂπÖÂÑ™ÂÖà„É¢„Éº„ÉâÔºöÁ∏¶„ÅåÂ∞è„Åï„ÅÑÂ†¥ÂêàÔºàÈ´ò„Åï400px‰ª•‰∏ãÔºâ */
		@media screen and (max-height: 400px) {
			.detail-panel {
				min-height: 200px;
			}
		}

		/* Êäò„Çä„Åü„Åü„ÅøÂèØËÉΩ„Å™Â∑¶„Éë„Éç„É´ÔºàÂ∞èÁîªÈù¢Áî®Ôºâ */
		.panel-toggle {
			display: none;
			position: absolute;
			top: 10px;
			right: 10px;
			background: var(--vscode-button-background);
			color: var(--vscode-button-foreground);
			border: none;
			border-radius: 3px;
			padding: 4px 8px;
			font-size: 12px;
			cursor: pointer;
			z-index: 100;
		}

		@media screen and (max-width: 900px) {
			.panel-toggle {
				display: block;
			}
			
			.search-panel.collapsed {
				flex: 0 0 40px;
				overflow: hidden;
			}
			
			.search-panel.collapsed .search-header,
			.search-panel.collapsed .prompt-list {
				display: none;
			}
		}

		/* „Ç≥„É≥„Éë„ÇØ„Éà„É¢„Éº„ÉâÔºöÈ´ò„Åï„ÅåÂà∂Èôê„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà */
		body.compact-mode .container {
			height: auto;
			max-height: 400px;
		}

		body.compact-mode .search-panel {
			max-height: 60px;
		}

		body.compact-mode .detail-panel {
			min-height: 150px;
		}

		body.compact-mode .variable-panel {
			max-height: 60px;
		}

		body.compact-mode .prompt-list {
			max-height: 40px;
		}

		body.compact-mode .detail-content {
			max-height: 100px;
			overflow-y: auto;
		}

		/* „Çπ„ÇØ„É≠„Éº„É´ÊúÄÈÅ©Âåñ */
		.detail-content {
			overflow-y: auto;
		}

		.prompt-list {
			overflow-y: auto;
		}
	</style>
</head>
<body>
	<div class="container">
		<!-- Â∑¶ÂÅ¥: Ê§úÁ¥¢„Éª‰∏ÄË¶ß„Éë„Éç„É´ -->
		<div class="panel search-panel scrollbar" id="searchPanel">
			<div class="search-header">
				<h3 class="panel-header-title">üìù „Éó„É≠„É≥„Éó„Éà‰∏ÄË¶ß</h3>
				<button class="panel-toggle-btn" onclick="togglePanel('search')" title="„Éë„Éç„É´„ÅÆË°®Á§∫/ÈùûË°®Á§∫">
					üëÅÔ∏è
				</button>
			</div>
			<div class="search-content">
				<button class="add-button" onclick="createPrompt()">
					+
				</button>
				<input 
					type="text" 
					class="search-box" 
					id="searchInput"
					placeholder="üîé" 
					oninput="searchPrompts(this.value)"
				/>
			</div>
			<div class="prompt-list scrollbar" id="promptList">
				<div class="empty-state">
					<div class="empty-icon">üì≠</div>
					<div>„Éó„É≠„É≥„Éó„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
					<div style="margin-top: 8px; font-size: 11px;">„ÄåÊñ∞„Åó„ÅÑ„Éó„É≠„É≥„Éó„Éà„ÇíËøΩÂä†„Äç„Åã„ÇâÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜ</div>
				</div>
			</div>
		</div>
		
		<!-- Âè≥ÂÅ¥: Ë©≥Á¥∞Ë°®Á§∫„Å®Â§âÊï∞Ë®≠ÂÆö„Éë„Éç„É´ -->
		<div class="panel detail-panel scrollbar" id="detailPanel">
			<div class="search-header">
				<h3 class="panel-header-title">üìÑ „Éó„É≠„É≥„Éó„ÉàË©≥Á¥∞</h3>
				<button class="panel-toggle-btn" onclick="togglePanel('detail')" title="„Éë„Éç„É´„ÅÆË°®Á§∫/ÈùûË°®Á§∫">
					üëÅÔ∏è
				</button>
			</div>
			
			<!-- „Éó„É≠„É≥„Éó„ÉàË©≥Á¥∞„Çª„ÇØ„Ç∑„Éß„É≥ (3/5) -->
			<div class="prompt-detail-section" id="promptDetail">
				<div class="empty-state">
					<div class="empty-icon">üëà</div>
					<div>Â∑¶ÂÅ¥„Åã„Çâ„Éó„É≠„É≥„Éó„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
				</div>
			</div>
			
			<!-- Â§âÊï∞Ë®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥ (2/5) -->
			<div class="variable-section" id="variablePanel">
				<div class="variable-header">
					<h3 class="variable-title">‚öôÔ∏è Â§âÊï∞Ë®≠ÂÆö</h3>
				</div>
				<div class="empty-state">
					<div class="empty-icon">‚öôÔ∏è</div>
					<div>„Éó„É≠„É≥„Éó„Éà„ÇíÈÅ∏Êäû„Åô„Çã„Å®<br>Â§âÊï∞Ë®≠ÂÆö„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</div>
					<div style="margin-top: 12px; font-size: 11px;">Ôºà„É¨„Éô„É´5„ÅßÂÆüË£Ö‰∫àÂÆöÔºâ</div>
				</div>
			</div>
		</div>
	</div>
	
	<script>
		const vscode = acquireVsCodeApi();
		let currentPrompts = [];
		let selectedPrompt = null;
		
		// VS Code „Åã„Çâ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèó‰ø°
		window.addEventListener('message', event => {
			const message = event.data;
			
			switch (message.type) {
				case 'updatePrompts':
					updatePromptList(message.prompts, message.selectedPromptId, message.isSearching);
					break;
				case 'showPromptDetail':
					showPromptDetail(message.prompt);
					break;
				case 'clearPromptDetail':
					clearPromptDetail();
					break;
				case 'getVariableValues':
					getAndSendVariableValues();
					break;
				case 'fileSelected':
					handleFileSelected(message.variableName, message.fileName);
					break;
			}
		});
		
		// ÂàùÊúüÂåñÂÆå‰∫Ü„ÇíÈÄöÁü•
		document.addEventListener('DOMContentLoaded', () => {
			initKeyboardShortcuts();
			initResponsiveLayout();
			initGlobalDragDropPrevention();
			vscode.postMessage({ type: 'ready' });
		});
		
		// „Ç∞„É≠„Éº„Éê„É´„Å™„Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÈò≤Ê≠¢
		function initGlobalDragDropPrevention() {
			// bodyË¶ÅÁ¥†„Å´ÂØæ„Åó„Å¶„ÇÇ„Éâ„É≠„ÉÉ„Éó„ÇíÈò≤Ê≠¢
			document.body.addEventListener('dragover', (e) => {
				e.preventDefault();
				e.stopPropagation();
				e.dataTransfer.dropEffect = 'none';
			}, true);
			
			document.body.addEventListener('drop', (e) => {
				e.preventDefault();
				e.stopPropagation();
				console.log('„Ç∞„É≠„Éº„Éê„É´„Éâ„É≠„ÉÉ„Éó„Ç§„Éô„É≥„Éà„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü');
				return false;
			}, true);
			
			// window „É¨„Éô„É´„Åß„ÇÇ„Éñ„É≠„ÉÉ„ÇØ
			window.addEventListener('dragover', (e) => {
				e.preventDefault();
				e.stopPropagation();
			}, true);
			
			window.addEventListener('drop', (e) => {
				e.preventDefault();
				e.stopPropagation();
				console.log('Window„É¨„Éô„É´„Éâ„É≠„ÉÉ„Éó„Ç§„Éô„É≥„Éà„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Åæ„Åó„Åü');
				return false;
			}, true);
		}

		// „É¨„Çπ„Éù„É≥„Ç∑„Éñ„É¨„Ç§„Ç¢„Ç¶„Éà„ÅÆÂàùÊúüÂåñ
		function initResponsiveLayout() {
			// „Ç¶„Ç£„É≥„Éâ„Ç¶„Çµ„Ç§„Ç∫Â§âÊõ¥ÊôÇ„ÅÆÂá¶ÁêÜ
			window.addEventListener('resize', handleResize);
			
			// ÂàùÊúü„É¨„Ç§„Ç¢„Ç¶„Éà„ÅÆË™øÊï¥
			handleResize();
		}

		function handleResize() {
			// ÁîªÈù¢„Çµ„Ç§„Ç∫„Å´Èñ¢‰øÇ„Å™„ÅèÂ∏∏„Å´Âêå„Åò„É¨„Ç§„Ç¢„Ç¶„Éà„ÇíÁ∂≠ÊåÅ
			console.log('„Ç¶„Ç£„É≥„Éâ„Ç¶„Çµ„Ç§„Ç∫:', window.innerWidth);
		}
		
		// „Ç≠„Éº„Éú„Éº„Éâ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥
		document.addEventListener('keydown', (event) => {
			handleKeyboardNavigation(event);
		});
		
		// „Ç≠„Éº„Éú„Éº„Éâ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„ÇíÂá¶ÁêÜ
		function handleKeyboardNavigation(event) {
			// Ctrl+N: Êñ∞„Åó„ÅÑ„Éó„É≠„É≥„Éó„Éà‰ΩúÊàê
			if (event.ctrlKey && event.key === 'n') {
				event.preventDefault();
				createPrompt();
				return;
			}
			
			// Enter: ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Éó„É≠„É≥„Éó„Éà„ÅÆË©≥Á¥∞Ë°®Á§∫ÔºàÂ§âÊï∞ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ‰ª•Â§ñÔºâ
			if (event.key === 'Enter' && !event.ctrlKey && !event.shiftKey) {
				// Â§âÊï∞ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Åß„ÅÆEnter„Ç≠„Éº„ÅØÁÑ°Ë¶ñ
				if (event.target && event.target.classList && event.target.classList.contains('variable-input')) {
					return;
				}
				
				const selectedItem = document.querySelector('.prompt-item.selected');
				if (selectedItem) {
					event.preventDefault();
					selectPrompt(selectedItem.dataset.id);
				}
				return;
			}
			
			// Áü¢Âç∞„Ç≠„Éº: „Éó„É≠„É≥„Éó„ÉàÈÅ∏Êäû
			if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
				event.preventDefault();
				navigatePromptList(event.key === 'ArrowDown' ? 1 : -1);
				return;
			}
			
			// Delete: ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Éó„É≠„É≥„Éó„Éà„ÇíÂâäÈô§
			if (event.key === 'Delete') {
				const selectedItem = document.querySelector('.prompt-item.selected');
				if (selectedItem) {
					event.preventDefault();
					deletePrompt(selectedItem.dataset.id);
				}
				return;
			}
			
			// Escape: Ê§úÁ¥¢„Éú„ÉÉ„ÇØ„Çπ„Çí„ÇØ„É™„Ç¢
			if (event.key === 'Escape') {
				const searchBox = document.getElementById('searchBox');
				if (searchBox && searchBox.value) {
					event.preventDefault();
					searchBox.value = '';
					searchPrompts('');
					searchBox.focus();
				}
				return;
			}
			
			// /: Ê§úÁ¥¢„Éú„ÉÉ„ÇØ„Çπ„Å´„Éï„Ç©„Éº„Ç´„Çπ
			if (event.key === '/' && !event.ctrlKey && !event.altKey) {
				const searchBox = document.getElementById('searchBox');
				if (searchBox && document.activeElement !== searchBox) {
					event.preventDefault();
					searchBox.focus();
					searchBox.select();
				}
				return;
			}
		}
		
		// „Éó„É≠„É≥„Éó„Éà‰∏ÄË¶ß„Çí„Éä„Éì„Ç≤„Éº„Éà
		function navigatePromptList(direction) {
			const items = document.querySelectorAll('.prompt-item');
			if (items.length === 0) return;
			
			const selectedItem = document.querySelector('.prompt-item.selected');
			let newIndex = 0;
			
			if (selectedItem) {
				const currentIndex = Array.from(items).indexOf(selectedItem);
				newIndex = currentIndex + direction;
				
				// ÁØÑÂõ≤„ÉÅ„Çß„ÉÉ„ÇØ
				if (newIndex < 0) newIndex = items.length - 1;
				if (newIndex >= items.length) newIndex = 0;
			}
			
			// Êñ∞„Åó„ÅÑ„Ç¢„Ç§„ÉÜ„É†„ÇíÈÅ∏Êäû
			const newItem = items[newIndex];
			document.querySelectorAll('.prompt-item').forEach(item => {
				item.classList.remove('selected');
			});
			newItem.classList.add('selected');
			
			// „Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶Ë°®Á§∫
			newItem.scrollIntoView({ 
				behavior: 'smooth', 
				block: 'nearest' 
			});
		}
		
		// „Éó„É≠„É≥„Éó„Éà‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
		function updatePromptList(prompts, selectedPromptId = null, isSearching = false) {
			console.log('updatePromptList called with:', prompts, 'selectedId:', selectedPromptId, 'isSearching:', isSearching);
			currentPrompts = prompts;
			const listElement = document.getElementById('promptList');
			
			if (prompts.length === 0) {
				console.log('„Éó„É≠„É≥„Éó„Éà„Åå0‰ª∂„ÅÆ„Åü„ÇÅÁ©∫„ÅÆÁä∂ÊÖã„ÇíË°®Á§∫');
				listElement.innerHTML = \`
					<div class="empty-state">
						<div class="empty-icon">üì≠</div>
						<div>„Éó„É≠„É≥„Éó„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
						<div style="margin-top: 8px; font-size: 11px;">„ÄåÊñ∞„Åó„ÅÑ„Éó„É≠„É≥„Éó„Éà„ÇíËøΩÂä†„Äç„Åã„ÇâÂßã„ÇÅ„Åæ„Åó„Çá„ÅÜ</div>
					</div>
				\`;
				return;
			}
			
			listElement.innerHTML = prompts.map(prompt => {
				const isSelected = selectedPromptId === prompt.id;
				return \`
					<div class="prompt-item\${isSelected ? ' selected' : ''}" 
						onclick="selectPrompt('\${prompt.id}')" 
						data-id="\${prompt.id}">
						<div class="prompt-title">
							\${prompt.isFavorite ? '<span class="favorite-icon">‚≠ê</span> ' : ''}\${escapeHtml(prompt.title)}
						</div>
						<div class="prompt-summary">\${escapeHtml(prompt.content.substring(0, 60))}\${prompt.content.length > 60 ? '...' : ''}</div>
						<div class="prompt-meta">
							<span>number of uses: <span class="usage-count">\${prompt.usageCount}</span></span>
						</div>
					</div>
				\`;
			}).join('');
		}
		
		// „Éó„É≠„É≥„Éó„Éà„ÇíÈÅ∏Êäû
		function selectPrompt(id) {
			// ÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞
			document.querySelectorAll('.prompt-item').forEach(item => {
				item.classList.remove('selected');
			});
			document.querySelector(\`[data-id="\${id}"]\`).classList.add('selected');
			
			vscode.postMessage({ type: 'selectPrompt', id });
		}
		
		// „Éó„É≠„É≥„Éó„ÉàË©≥Á¥∞„ÇíË°®Á§∫
		function showPromptDetail(prompt) {
			selectedPrompt = prompt;
			const detailElement = document.getElementById('promptDetail');
			
			// „Éó„É≠„É≥„Éó„ÉàÂÜÖÂÆπ„Çí„Éè„Ç§„É©„Ç§„ÉàÔºàÂ§âÊï∞ÈÉ®ÂàÜ„ÇíÂº∑Ë™øË°®Á§∫Ôºâ
			const highlightedContent = highlightVariables(prompt.content);
			
			// Á©∫„ÅÆ„Éó„É≠„É≥„Éó„Éà„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö
			const isEmpty = !prompt.content || prompt.content.trim() === '';
			const emptyClass = isEmpty ? ' empty' : '';
			
			detailElement.innerHTML = \`
				<div class="detail-header">
					<h2 class="detail-title editable" onclick="startEditTitle()" title="„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Á∑®ÈõÜ">\${prompt.isFavorite ? '‚≠ê ' : ''}\${escapeHtml(prompt.title)}</h2>
					<div class="detail-actions">
						<button class="action-button" onclick="deletePrompt('\${prompt.id}')" title="ÂâäÈô§">üóëÔ∏è</button>
						<button class="action-button" onclick="copyPrompt('\${prompt.id}')" title="„Ç≥„Éî„Éº">üìã</button>
						<button class="action-button undecided" onclick="executePrompt()" title="ÂÆüË°å">‚ñ∂Ô∏è</button>
					</div>
				</div>
				
				<div class="detail-content editable\${emptyClass}" onclick="startEditContent()" title="„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Á∑®ÈõÜ">\${highlightedContent}</div>
				
				<div class="detail-meta">
					<div class="meta-item">
						<span>number of uses:</span>
						<span>\${prompt.usageCount}Âõû</span>
					</div>
				</div>
			\`;
			
			updateVariablePanel(prompt);
		}
		
		// Â§âÊï∞ÈÉ®ÂàÜ„Çí„Éè„Ç§„É©„Ç§„Éà
		function highlightVariables(content) {
			const escaped = escapeHtml(content);
			
			// ‰∏ÄÂ∫¶„Å´„Åô„Åπ„Å¶„ÅÆÂ§âÊï∞„Éë„Çø„Éº„É≥„ÇíÂá¶ÁêÜÔºàÈáçË§á„ÇíÈÅø„Åë„Çã„Åü„ÇÅÔºâ
			return escaped.replace(
				/\\{([\\w\\u3040-\\u309F\\u30A0-\\u30FF\\u4E00-\\u9FAF\\u3400-\\u4DBF]+)(?::([^}]+))?\\}/g,
				(match, variableName, defaultValue) => {
					if (defaultValue) {
						if (defaultValue.startsWith('@')) {
							// „Éï„Ç°„Ç§„É´„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÅÆÂ†¥Âêà
							return \`<span class="variable-highlight">{\${variableName}:<span class="file-default-highlight">\${defaultValue}</span>}</span>\`;
						} else {
							// ÈÄöÂ∏∏„ÅÆ„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÅÆÂ†¥Âêà
							return \`<span class="variable-highlight">{\${variableName}:\${defaultValue}}</span>\`;
						}
					} else {
						// „Éá„Éï„Ç©„É´„ÉàÂÄ§„Å™„Åó„ÅÆÂ†¥Âêà
						return \`<span class="variable-highlight">{\${variableName}}</span>\`;
					}
				}
			);
		}
		
		// Â§âÊï∞„Éë„Éç„É´„ÇíÊõ¥Êñ∞
		function updateVariablePanel(prompt) {
			const variableElement = document.getElementById('variablePanel');
			
			// „Éó„É≠„É≥„Éó„ÉàÂÜÖÂÆπ„Åã„ÇâÂ§âÊï∞„ÇíÊäΩÂá∫ÔºàÊó•Êú¨Ë™ûÂØæÂøúÁâàÔºâ
			const variables = extractVariables(prompt.content);
			
			if (variables.length === 0) {
				variableElement.innerHTML = \`
					<div class="empty-state">
						<div class="empty-icon">‚úÖ</div>
						<div>„Åì„ÅÆ„Éó„É≠„É≥„Éó„Éà„Å´„ÅØ<br>Â§âÊï∞„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>
					</div>
				\`;
			} else {
				variableElement.innerHTML = \`
					<div class="variable-list">
						\${variables.map(variable => \`
							<div class="variable-item">
								<label class="variable-label" for="var_\${variable.name}">\${variable.name}:</label>
								<div class="variable-input-container">
									<input 
										type="text" 
										class="variable-input" 
										id="var_\${variable.name}"
										placeholder="\${variable.defaultValue || 'Enter values or click üìÅ to select file'}"
										value="\${variable.defaultValue || ''}"
										onkeydown="handleVariableInputKeydown(event)"
										title="\${variable.defaultValue && variable.defaultValue.startsWith('@') ? 'File default: ' + variable.defaultValue : (variable.defaultValue ? 'Default value: ' + variable.defaultValue : '')}"
									/>
									<button 
										class="set-default-button" 
										onclick="setCurrentValueAsDefault('\${variable.name}')"
										title="Set current value as default"
									>üìå</button>
									<button 
										class="file-select-button" 
										onclick="selectFileForVariable('\${variable.name}')"
										title="„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû"
									>üìÅ</button>
								</div>
							</div>
						\`).join('')}
					</div>

				\`;
				

			}
		}
		
		// Â§âÊï∞„ÇíÊäΩÂá∫ÔºàÊó•Êú¨Ë™ûÂØæÂøúÁâàÔºâ
		function extractVariables(content) {
			// Êó•Êú¨Ë™û„ÇíÂê´„ÇÄÂ§âÊï∞Âêç„Å´ÂØæÂøú„Åó„ÅüÊ≠£Ë¶èË°®Áèæ
			const regex = /\\{([\\w\\u3040-\\u309F\\u30A0-\\u30FF\\u4E00-\\u9FAF\\u3400-\\u4DBF]+(?::[^}]*)?)\\}/g;
			const variables = [];
			let match;
			
			while ((match = regex.exec(content)) !== null) {
				// Â§âÊï∞Âêç„Å®„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÇíÂàÜÈõ¢
				const fullContent = match[1];
				const separatorIndex = fullContent.indexOf(':');
				const variableName = separatorIndex === -1 ? fullContent : fullContent.substring(0, separatorIndex);
				const defaultValue = separatorIndex === -1 ? '' : fullContent.substring(separatorIndex + 1);
				
				// ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
				if (!variables.some(v => v.name === variableName)) {
					variables.push({
						name: variableName,
						defaultValue: defaultValue
					});
				}
			}
			
			return variables;
		}

		// „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅÆ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
		function setupDragAndDrop() {
			// „Éâ„Ç≠„É•„É°„É≥„ÉàÂÖ®‰Ωì„Åß„Éâ„É≠„ÉÉ„Éó„Ç§„Éô„É≥„Éà„Çí„Éñ„É≠„ÉÉ„ÇØÔºàÂ§âÊï∞ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ‰ª•Â§ñÔºâ
			document.addEventListener('dragover', (e) => {
				if (!e.target.classList.contains('variable-input')) {
					e.preventDefault();
					e.stopPropagation();
				}
			}, true);
			
			document.addEventListener('drop', (e) => {
				if (!e.target.classList.contains('variable-input')) {
					e.preventDefault();
					e.stopPropagation();
					console.log('ÈùûÂ§âÊï∞„Éï„Ç£„Éº„É´„Éâ„Åß„ÅÆ„Éâ„É≠„ÉÉ„Éó„Çí„Éñ„É≠„ÉÉ„ÇØ„Åó„Åæ„Åó„Åü');
				}
			}, true);
			
			const variableInputs = document.querySelectorAll('.variable-input');
			
			variableInputs.forEach(input => {
				// „Éâ„É©„ÉÉ„Ç∞„Ç™„Éº„Éê„ÉºÊôÇ„ÅÆÂá¶ÁêÜ
				input.addEventListener('dragover', (e) => {
					e.preventDefault();
					e.stopPropagation();
					input.style.backgroundColor = 'var(--vscode-list-hoverBackground)';
					input.style.borderColor = 'var(--vscode-focusBorder)';
				}, true);
				
				// „Éâ„É©„ÉÉ„Ç∞„É™„Éº„ÉñÊôÇ„ÅÆÂá¶ÁêÜ
				input.addEventListener('dragleave', (e) => {
					e.preventDefault();
					e.stopPropagation();
					input.style.backgroundColor = '';
					input.style.borderColor = '';
				}, true);
				
				// „Éâ„É≠„ÉÉ„ÉóÊôÇ„ÅÆÂá¶ÁêÜ
				input.addEventListener('drop', async (e) => {
					e.preventDefault();
					e.stopPropagation();
					input.style.backgroundColor = '';
					input.style.borderColor = '';
					
					console.log('„Éâ„É≠„ÉÉ„Éó„Ç§„Éô„É≥„Éà„ÅåÂ§âÊï∞ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅßÂá¶ÁêÜ„Åï„Çå„Åæ„Åó„Åü');
					
					const files = e.dataTransfer.files;
					if (files.length > 0) {
						const file = files[0];
						const variableName = input.id.replace('var_', '');
						
						console.log(\`„Éï„Ç°„Ç§„É´„Åå„Éâ„É≠„ÉÉ„Éó„Åï„Çå„Åæ„Åó„Åü: \${file.name}\`);
						
						// FileReader API„Åß„Éï„Ç°„Ç§„É´ÂÜÖÂÆπ„ÇíÁõ¥Êé•Ë™≠„ÅøÂèñ„Çä
						const reader = new FileReader();
						reader.onload = function(e) {
							const content = e.target.result;
							
							console.log(\`„Éï„Ç°„Ç§„É´ÂÜÖÂÆπË™≠„ÅøËæº„ÅøÂÆå‰∫Ü: \${file.name} (\${content.length}ÊñáÂ≠ó)\`);
							
							// VS Code„Å´„Éï„Ç°„Ç§„É´ÊÉÖÂ†±„ÇíÈÄÅ‰ø°
							vscode.postMessage({
								type: 'fileContentLoaded',
								fileName: file.name,
								variableName: variableName,
								content: content
							});
							
							// ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÇíÊõ¥Êñ∞
							input.value = \`@\${file.name}\`;
							input.title = \`„Éï„Ç°„Ç§„É´: \${file.name} (Ë™≠„ÅøËæº„ÅøÊ∏à„Åø)\`;
						};
						
						reader.onerror = function(e) {
							console.error('„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
						};
						
						reader.readAsText(file);
					}
				}, true);
			});
		}



		// ÁèæÂú®„ÅÆÂÄ§„Çí„Éá„Éï„Ç©„É´„ÉàÂÄ§„Å®„Åó„Å¶Ë®≠ÂÆö
		function setCurrentValueAsDefault(variableName) {
			const button = event ? event.target : null;
			const input = document.getElementById(\`var_\${variableName}\`);
			
			if (!input || !selectedPrompt) {
				console.error('ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Åæ„Åü„ÅØÈÅ∏Êäû„Åï„Çå„Åü„Éó„É≠„É≥„Éó„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
				return;
			}
			
			const currentValue = input.value.trim();
			if (!currentValue) {
				console.log('ÁèæÂú®„ÅÆÂÄ§„ÅåÁ©∫„ÅÆ„Åü„ÇÅ„ÄÅ„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÅÆË®≠ÂÆö„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô');
				return;
			}
			
			console.log(\`„Éá„Éï„Ç©„É´„ÉàÂÄ§Ë®≠ÂÆöÈñãÂßã: \${variableName} = "\${currentValue}"\`);
			
			if (button) {
				animateButtonClick(button, () => {
					// „Éó„É≠„É≥„Éó„ÉàÂÜÖÂÆπ„ÇíÊõ¥Êñ∞
					updatePromptWithNewDefault(variableName, currentValue);
				});
			} else {
				updatePromptWithNewDefault(variableName, currentValue);
			}
		}

		// „Éó„É≠„É≥„Éó„ÉàÂÜÖÂÆπ„ÅÆ„Éá„Éï„Ç©„É´„ÉàÂÄ§„ÇíÊõ¥Êñ∞
		function updatePromptWithNewDefault(variableName, newDefaultValue) {
			if (!selectedPrompt) return;
			
			let updatedContent = selectedPrompt.content;
			
			// Êó¢Â≠ò„ÅÆÂ§âÊï∞„Éë„Çø„Éº„É≥„ÇíÊ§úÁ¥¢
			const existingPattern = new RegExp(\`\\\\{\${variableName}(?::[^}]*)?\\\\}\`, 'g');
			const newVariablePattern = \`{\${variableName}:\${newDefaultValue}}\`;
			
			// Â§âÊï∞„Éë„Çø„Éº„É≥„ÇíÊñ∞„Åó„ÅÑ„Éá„Éï„Ç©„É´„ÉàÂÄ§‰ªò„Åç„Å´ÁΩÆÊèõ
			updatedContent = updatedContent.replace(existingPattern, newVariablePattern);
			
			console.log(\`„Éó„É≠„É≥„Éó„ÉàÂÜÖÂÆπÊõ¥Êñ∞: \${selectedPrompt.title}\`);
			console.log('Êõ¥Êñ∞Ââç:', selectedPrompt.content);
			console.log('Êõ¥Êñ∞Âæå:', updatedContent);
			
			// VS Code„Å´„Éó„É≠„É≥„Éó„ÉàÊõ¥Êñ∞„ÇíÈÄÅ‰ø°
			vscode.postMessage({
				type: 'updatePrompt',
				id: selectedPrompt.id,
				updates: { content: updatedContent }
			});
			
			// „É≠„Éº„Ç´„É´„ÅÆË°®Á§∫„ÇÇÊõ¥Êñ∞
			selectedPrompt.content = updatedContent;
			
			// „Éó„É≠„É≥„Éó„ÉàË©≥Á¥∞Ë°®Á§∫„ÇíÊõ¥Êñ∞ÔºàÂ§âÊï∞„Éè„Ç§„É©„Ç§„Éà„Åß@default„ÅåÁ†¥Á∑öÊû†„ÅßË°®Á§∫„Åï„Çå„ÇãÔºâ
			showPromptDetail(selectedPrompt);
		}

		// „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÂá¶ÁêÜ
		function selectFileForVariable(variableName) {
			const button = event ? event.target : null;
			console.log(\`„Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÈñãÂßã: Â§âÊï∞ \${variableName}\`);
			
			if (button) {
				animateButtonClick(button, () => {
					vscode.postMessage({
						type: 'selectFileForVariable',
						variableName: variableName
					});
				});
			} else {
				vscode.postMessage({
					type: 'selectFileForVariable',
					variableName: variableName
				});
			}
		}

		// „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÁµêÊûúÂá¶ÁêÜ
		function handleFileSelected(variableName, fileName) {
			console.log(\`„Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÁµêÊûú: \${variableName} -> \${fileName}\`);
			
			const input = document.getElementById(\`var_\${variableName}\`);
			if (input) {
				input.value = \`@\${fileName}\`;
				input.title = \`„Éï„Ç°„Ç§„É´: \${fileName} (ÈÅ∏ÊäûÊ∏à„Åø)\`;
				console.log(\`Â§âÊï∞„Éï„Ç£„Éº„É´„ÉâÊõ¥Êñ∞: \${variableName} = @\${fileName}\`);
			} else {
				console.error(\`Â§âÊï∞ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: var_\${variableName}\`);
			}
		}

		// Â§âÊï∞ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆ„Ç≠„Éº„Éú„Éº„ÉâÂá¶ÁêÜ
		function handleVariableInputKeydown(event) {
			// Enter„Ç≠„Éº„ÅÆÂ†¥Âêà„ÄÅ„Éá„Éï„Ç©„É´„ÉàÂãï‰Ωú„ÇíÈò≤Ê≠¢Ôºà„Éï„Ç©„Éº„É†ÈÄÅ‰ø°„ÇÑ„Éö„Éº„Ç∏„É™„É≠„Éº„Éâ„ÇíÈò≤„ÅêÔºâ
			if (event.key === 'Enter') {
				event.preventDefault();
				event.stopPropagation();
				// „Éï„Ç©„Éº„Ç´„Çπ„ÇíÁ∂≠ÊåÅ„Åó„ÄÅÂÄ§„Çí‰øùÊåÅ
				console.log('Â§âÊï∞ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅßEnter„Ç≠„Éº„ÅåÊäº„Åï„Çå„Åæ„Åó„Åü - „Éá„Éï„Ç©„É´„ÉàÂãï‰Ωú„ÇíÈò≤Ê≠¢');
				return false;
			}
		}

		// Â§âÊï∞ÂÄ§„ÇíÂèñÂæó„Åó„Å¶VS Code„Å´ÈÄÅ‰ø°
		function getAndSendVariableValues() {
			console.log('=== getAndSendVariableValuesÈñãÂßã ===');
			const values = {};
			
			// ÁèæÂú®Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÂ§âÊï∞ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Åã„ÇâÂÄ§„ÇíÂèñÂæó
			const variableInputs = document.querySelectorAll('.variable-input');
			console.log(\`\${variableInputs.length}ÂÄã„ÅÆÂ§âÊï∞ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü\`);
			
			variableInputs.forEach(input => {
				const variableName = input.id.replace('var_', '');
				const value = input.value.trim();
				values[variableName] = value;
				console.log(\`Â§âÊï∞ÂÄ§ÂèñÂæó: \${variableName} = "\${value}"\`);
			});
			
			console.log('ÂèñÂæó„Åó„ÅüÂ§âÊï∞ÂÄ§‰∏ÄË¶ß:', values);
			
			// VS Code„Å´Â§âÊï∞ÂÄ§„ÇíÈÄÅ‰ø°
			vscode.postMessage({
				type: 'variableValues',
				values: values
			});
			
			console.log('=== getAndSendVariableValuesÂÆå‰∫Ü ===');
		}
		

		
		// „Éó„É≠„É≥„Éó„Éà„ÇíÊ§úÁ¥¢
		function searchPrompts(query) {
			vscode.postMessage({ type: 'searchPrompts', query });
		}

		// „Éó„É≠„É≥„Éó„ÉàË©≥Á¥∞„Çí„ÇØ„É™„Ç¢
		function clearPromptDetail() {
			selectedPrompt = null;
			const detailElement = document.getElementById('promptDetail');
			detailElement.innerHTML = \`
				<div class="empty-state">
					<div class="empty-icon">üëà</div>
					<div>Â∑¶ÂÅ¥„Åã„Çâ„Éó„É≠„É≥„Éó„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
				</div>
			\`;
			
			// Â§âÊï∞„Éë„Éç„É´„ÇÇ„ÇØ„É™„Ç¢
			const variableElement = document.getElementById('variablePanel');
			variableElement.innerHTML = \`
				<div class="empty-state">
					<div class="empty-icon">‚öôÔ∏è</div>
					<div>„Éó„É≠„É≥„Éó„Éà„ÇíÈÅ∏Êäû„Åô„Çã„Å®<br>Â§âÊï∞Ë®≠ÂÆö„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô</div>
					<div style="margin-top: 12px; font-size: 11px;">Ôºà„É¨„Éô„É´5„ÅßÂÆüË£Ö‰∫àÂÆöÔºâ</div>
				</div>
			\`;
		}
		
		// „Çø„Ç§„Éà„É´Á∑®ÈõÜ„ÇíÈñãÂßã
		function startEditTitle() {
			if (!selectedPrompt) return;
			
			const titleElement = document.querySelector('.detail-title');
			if (!titleElement || titleElement.classList.contains('editing')) return;
			
			const currentTitle = selectedPrompt.title;
			const favoriteIcon = selectedPrompt.isFavorite ? '‚≠ê ' : '';
			
			titleElement.classList.add('editing');
			titleElement.innerHTML = \`
				\${favoriteIcon}<input 
					type="text" 
					class="edit-input" 
					value="\${escapeHtml(currentTitle)}" 
					onblur="saveTitle(this.value)"
					onkeydown="handleTitleKeydown(event, this.value)"
					style="display: inline-block; width: auto; min-width: 200px;"
				/>
			\`;
			
			const input = titleElement.querySelector('.edit-input');
			input.focus();
			input.select();
		}
		
		// „Ç≥„É≥„ÉÜ„É≥„ÉÑÁ∑®ÈõÜ„ÇíÈñãÂßã
		function startEditContent() {
			if (!selectedPrompt) return;
			
			const contentElement = document.querySelector('.detail-content');
			if (!contentElement || contentElement.classList.contains('editing')) return;
			
			const currentContent = selectedPrompt.content;
			
			contentElement.classList.add('editing');
			contentElement.innerHTML = \`
				<textarea 
					class="edit-input edit-textarea" 
					onblur="saveContent(this.value)"
					onkeydown="handleContentKeydown(event)"
				>\${escapeHtml(currentContent)}</textarea>
			\`;
			
			const textarea = contentElement.querySelector('.edit-textarea');
			textarea.focus();
		}
		
		// „Çø„Ç§„Éà„É´‰øùÂ≠ò
		function saveTitle(newTitle) {
			if (!selectedPrompt) return;
			
			newTitle = newTitle.trim();
			if (newTitle === '' || newTitle === selectedPrompt.title) {
				cancelTitleEdit();
				return;
			}
			
			vscode.postMessage({ 
				type: 'updatePrompt', 
				id: selectedPrompt.id,
				updates: { title: newTitle }
			});
			
			// Êö´ÂÆöÁöÑ„Å´Ë°®Á§∫„ÇíÊõ¥Êñ∞
			selectedPrompt.title = newTitle;
			cancelTitleEdit();
		}
		
		// „Ç≥„É≥„ÉÜ„É≥„ÉÑ‰øùÂ≠ò
		function saveContent(newContent) {
			if (!selectedPrompt) return;
			
			// Á©∫„ÅÆÂ†¥Âêà„ÇÑÂ§âÊõ¥„Åå„Å™„ÅÑÂ†¥Âêà„ÇÇ‰øùÂ≠ò„Åô„ÇãÔºàÁ©∫„Å´„Åô„Çã„ÅÆ„ÇÇÊúâÂäπ„Å™Êìç‰ΩúÔºâ
			if (newContent === selectedPrompt.content) {
				cancelContentEdit();
				return;
			}
			
			vscode.postMessage({ 
				type: 'updatePrompt', 
				id: selectedPrompt.id,
				updates: { content: newContent }
			});
			
			// Êö´ÂÆöÁöÑ„Å´Ë°®Á§∫„ÇíÊõ¥Êñ∞
			selectedPrompt.content = newContent;
			cancelContentEdit();
		}
		
		// „Çø„Ç§„Éà„É´Á∑®ÈõÜ„Ç≠„É£„É≥„Çª„É´
		function cancelTitleEdit() {
			if (!selectedPrompt) return;
			
			const titleElement = document.querySelector('.detail-title');
			if (!titleElement) return;
			
			titleElement.classList.remove('editing');
			const favoriteIcon = selectedPrompt.isFavorite ? '‚≠ê ' : '';
			titleElement.innerHTML = \`\${favoriteIcon}\${escapeHtml(selectedPrompt.title)}\`;
		}
		
		// „Ç≥„É≥„ÉÜ„É≥„ÉÑÁ∑®ÈõÜ„Ç≠„É£„É≥„Çª„É´
		function cancelContentEdit() {
			if (!selectedPrompt) return;
			
			const contentElement = document.querySelector('.detail-content');
			if (!contentElement) return;
			
			contentElement.classList.remove('editing');
			
			// Á©∫„ÅÆ„Éó„É≠„É≥„Éó„Éà„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö„Åó„Å¶empty„ÇØ„É©„Çπ„ÇíË®≠ÂÆö
			const isEmpty = !selectedPrompt.content || selectedPrompt.content.trim() === '';
			if (isEmpty) {
				contentElement.classList.add('empty');
			} else {
				contentElement.classList.remove('empty');
			}
			
			const highlightedContent = highlightVariables(selectedPrompt.content);
			contentElement.innerHTML = highlightedContent;
		}
		
		// „Çø„Ç§„Éà„É´Á∑®ÈõÜÊôÇ„ÅÆ„Ç≠„Éº„Éú„Éº„ÉâÂá¶ÁêÜ
		function handleTitleKeydown(event, value) {
			if (event.key === 'Enter') {
				event.preventDefault();
				saveTitle(value);
			} else if (event.key === 'Escape') {
				event.preventDefault();
				cancelTitleEdit();
			}
		}
		
		// „Ç≥„É≥„ÉÜ„É≥„ÉÑÁ∑®ÈõÜÊôÇ„ÅÆ„Ç≠„Éº„Éú„Éº„ÉâÂá¶ÁêÜ
		function handleContentKeydown(event) {
			if (event.key === 'Escape') {
				event.preventDefault();
				cancelContentEdit();
			} else if (event.ctrlKey && event.key === 'Enter') {
				event.preventDefault();
				saveContent(event.target.value);
			}
		}



		// ÈÄöÁü•Ê©üËÉΩ„ÅØÂâäÈô§„Åó„Åæ„Åó„Åü

		// „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
		function initKeyboardShortcuts() {
			document.addEventListener('keydown', (e) => {
				// Ctrl+F: Ê§úÁ¥¢„Éï„Ç©„Éº„Ç´„Çπ
				if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
					e.preventDefault();
					const searchInput = document.getElementById('searchInput');
					if (searchInput) {
						searchInput.focus();
						searchInput.select();
					}
				}
				
				// Ctrl+N: Êñ∞Ë¶è„Éó„É≠„É≥„Éó„Éà‰ΩúÊàê
				if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
					e.preventDefault();
					createPrompt();
				}
				
				// Ctrl+Enter: ÈÅ∏Êäû„Åó„Åü„Éó„É≠„É≥„Éó„Éà„ÇíÂÆüË°å
				if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
					e.preventDefault();
					if (selectedPrompt) {
						executePrompt();
					}
				}
				
				// Ctrl+C: ÈÅ∏Êäû„Åó„Åü„Éó„É≠„É≥„Éó„Éà„Çí„Ç≥„Éî„Éº
				if ((e.ctrlKey || e.metaKey) && e.key === 'c' && !e.shiftKey) {
					const activeElement = document.activeElement;
					// „ÉÜ„Ç≠„Çπ„ÉàÂÖ•Âäõ‰∏≠„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøÂÆüË°å
					if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
						e.preventDefault();
						if (selectedPrompt) {
							copyPrompt(selectedPrompt.id);
						}
					}
				}
				
				// Delete: ÈÅ∏Êäû„Åó„Åü„Éó„É≠„É≥„Éó„Éà„ÇíÂâäÈô§
				if (e.key === 'Delete' && selectedPrompt) {
					e.preventDefault();
					deletePrompt(selectedPrompt.id);
				}
				

			});
		}

		// „Éë„Éç„É´„ÅÆË°®Á§∫„ÉªÈùûË°®Á§∫Âàá„ÇäÊõø„ÅàÊ©üËÉΩ
		function togglePanel(panelType) {
			const container = document.querySelector('.container');
			let className, panelName, buttonSelector;
			
			switch (panelType) {
				case 'search':
					className = 'search-hidden';
					panelName = '„Éó„É≠„É≥„Éó„Éà‰∏ÄË¶ß';
					buttonSelector = '#searchPanel .panel-toggle-btn';
					break;
				case 'detail':
					className = 'detail-hidden';
					panelName = '„Éó„É≠„É≥„Éó„ÉàË©≥Á¥∞';
					buttonSelector = '#detailPanel .panel-toggle-btn';
					break;
				
				default:
					return;
			}
			
			const button = document.querySelector(buttonSelector);
			
			if (container.classList.contains(className)) {
				container.classList.remove(className);
				button.textContent = 'üëÅÔ∏è';
				button.title = '„Éë„Éç„É´„ÇíÈùûË°®Á§∫„Å´„Åô„Çã';
			} else {
				container.classList.add(className);
				button.textContent = 'üëÄ';
				button.title = '„Éë„Éç„É´„ÇíË°®Á§∫„Åô„Çã';
			}
		}
		
		// Êñ∞„Åó„ÅÑ„Éó„É≠„É≥„Éó„Éà„Çí‰ΩúÊàê
		function createPrompt() {
			const button = event ? event.target : null;
			console.log('createPrompt Èñ¢Êï∞„ÅåÂëº„Å≥Âá∫„Åï„Çå„Åæ„Åó„Åü');
			
			if (button) {
				animateButtonClick(button, () => {
					vscode.postMessage({ type: 'createPrompt' });
					console.log('createPrompt „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü');
				});
			} else {
				vscode.postMessage({ type: 'createPrompt' });
				console.log('createPrompt „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü');
			}
		}
		
		// „Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú
		function animateButtonClick(button, callback) {
			// „ÇØ„É™„ÉÉ„ÇØÂäπÊûú„ÇíËøΩÂä†
			button.classList.add('clicked');
			
			// Â∞ë„ÅóÈÅÖÂª∂„Åó„Å¶„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÂÆüË°å
			setTimeout(() => {
				if (callback) callback();
				
				// „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú„ÇíÂâäÈô§
				setTimeout(() => {
					button.classList.remove('clicked');
				}, 150);
			}, 100);
		}

		// „Éó„É≠„É≥„Éó„Éà„ÇíÂâäÈô§
		function deletePrompt(id) {
			const button = event ? event.target : null;
			if (button) {
				animateButtonClick(button, () => {
					vscode.postMessage({ type: 'deletePrompt', id });
				});
			} else {
				vscode.postMessage({ type: 'deletePrompt', id });
			}
		}
		
		// „Éó„É≠„É≥„Éó„Éà„Çí„Ç≥„Éî„Éº
		function copyPrompt(id) {
			const button = event ? event.target : null;
			const prompt = currentPrompts.find(p => p.id === id);
			if (prompt) {
				if (button) {
					animateButtonClick(button, () => {
						vscode.postMessage({ 
							type: 'copyPrompt', 
							id: id,
							content: prompt.content 
						});
					});
				} else {
					vscode.postMessage({ 
						type: 'copyPrompt', 
						id: id,
						content: prompt.content 
					});
				}
			}
		}
		
		// „Éó„É≠„É≥„Éó„Éà„ÇíÂÆüË°å
		function executePrompt() {
			if (!selectedPrompt) return;
			
			let content = selectedPrompt.content;
			
			// Â§âÊï∞„ÇíÁΩÆÊèõ
			const inputs = document.querySelectorAll('.variable-input');
			inputs.forEach(input => {
				const variableName = input.id.replace('var_', '');
				const value = input.value.trim();
				content = content.replace(new RegExp(\`\\\\{\${variableName}\\\\}\`, 'g'), value);
			});
			
			vscode.postMessage({ 
				type: 'executePrompt', 
				promptId: selectedPrompt.id,
				content 
			});
		}
		
		// „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£Èñ¢Êï∞
		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}
		
		function formatDate(dateStr) {
			const date = new Date(dateStr);
			return date.toLocaleDateString('ja-JP', {
				month: 'short',
				day: 'numeric'
			});
		}
	</script>
</body>
</html>`;
	}
}

// This method is called when your extension is activated
// Your extension is activated the very first time the command is executed
export async function activate(context: vscode.ExtensionContext) {
	// Use the console to output diagnostic information (console.log) and errors (console.error)
	// This line of code will only be executed once when your extension is activated
	console.log('Prompt Template Manager „ÅåËµ∑Âãï„Åó„Åæ„Åó„ÅüÔºÅ');
	console.log('Extension Context:', context);
	console.log('Extension URI:', context.extensionUri.toString());
	
	try {
		// Prompt Template Manager „ÅåÊ≠£Â∏∏„Å´„Ç¢„ÇØ„ÉÜ„Ç£„Éô„Éº„Éà„Åï„Çå„Åæ„Åó„Åü
	} catch (error) {
		console.error('ÂàùÊúü„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫„Ç®„É©„Éº:', error);
	}

	// VariableStorage„ÅÆÂàùÊúüÂåñ
	try {
		const variableStorage = VariableStorage.getInstance();
		await variableStorage.setContext(context);
		console.log('VariableStorage „ÅåÊ≠£Â∏∏„Å´ÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„Åü');
	} catch (error) {
		console.error('VariableStorage ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
	}

	// „Éó„É≠„É≥„Éó„Éà„Éû„Éç„Éº„Ç∏„É£„Éº„ÅÆÂàùÊúüÂåñ
	let promptManager: PromptManager;
	try {
		promptManager = new PromptManager(context);
		console.log('PromptManager „ÅåÊ≠£Â∏∏„Å´ÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„Åü');
	} catch (error) {
		console.error('PromptManager ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
		// Êã°ÂºµÊ©üËÉΩ„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü
		return;
	}

	// Â§âÊï∞Ë®≠ÂÆö„Éë„Éç„É´„ÅÆÁôªÈå≤Ôºà„Ç≥„Éû„É≥„ÉâÁôªÈå≤Ââç„Å´ÂÆüË°åÔºâ
	const variableSettingsProvider = new VariableSettingsPanel(context.extensionUri);
	context.subscriptions.push(
		vscode.window.registerWebviewViewProvider(VariableSettingsPanel.viewType, variableSettingsProvider)
	);

	// „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Éê„ÉºÁî®TreeDataProvider„ÅÆÁôªÈå≤
	const treeDataProvider = new PromptTemplateTreeProvider(promptManager);
	const treeView = vscode.window.createTreeView('promptTemplateManager.main', {
		treeDataProvider: treeDataProvider,
		showCollapseAll: false
	});
	context.subscriptions.push(treeView);

	// PromptManager„Å´TreeDataProvider„ÅÆÂèÇÁÖß„ÇíË®≠ÂÆöÔºàÊõ¥Êñ∞ÊôÇ„Å´ÈÄöÁü•„Åô„Çã„Åü„ÇÅÔºâ
	promptManager.setTreeDataProvider(treeDataProvider);

	// „É°„Ç§„É≥„Éë„Éç„É´„ÇíÈñã„Åè„Ç≥„Éû„É≥„Éâ
	const openPanelCommand = vscode.commands.registerCommand('prompt-template-manager.openPanel', async () => {
		console.log('openPanel „Ç≥„Éû„É≥„Éâ„ÅåÂÆüË°å„Åï„Çå„Åæ„Åó„Åü');
		try {
			PromptTemplatePanel.createOrShow(context.extensionUri, promptManager, variableSettingsProvider);
			console.log('Webview„Éë„Éç„É´„ÅåÊ≠£Â∏∏„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åó„Åü');
		} catch (error) {
			console.error('„Éë„Éç„É´Ë°®Á§∫‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü:', error);
		}
	});

	// Êñ∞„Åó„ÅÑ„Éó„É≠„É≥„Éó„Éà„Çí‰ΩúÊàê„Åô„Çã„Ç≥„Éû„É≥„Éâ
	const createPromptCommand = vscode.commands.registerCommand('prompt-template-manager.createPrompt', async () => {
		const title = await vscode.window.showInputBox({
			prompt: '„Éó„É≠„É≥„Éó„Éà„ÅÆ„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
			placeHolder: '„Çø„Ç§„Éà„É´'
		});

		if (title) {
			const content = await vscode.window.showInputBox({
				prompt: '„Éó„É≠„É≥„Éó„Éà„ÅÆÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
				placeHolder: '„Éó„É≠„É≥„Éó„Éà„ÅÆÂÜÖÂÆπ...'
			});

			if (content) {
				await promptManager.addPrompt({ title, content });
			}
		}
	});

	// „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç≥„Éû„É≥„ÉâÔºàÂæìÊù•ÁâàÔºâ
	const exportDataCommand = vscode.commands.registerCommand('prompt-template-manager.exportData', async () => {
		try {
			const exportData = await promptManager.exportData();
			
			// „Éï„Ç°„Ç§„É´„Å´‰øùÂ≠ò
			const saveUri = await vscode.window.showSaveDialog({
				defaultUri: vscode.Uri.file(`prompt-templates-${new Date().toISOString().slice(0, 10)}.json`),
				filters: {
					'JSON Files': ['json']
				}
			});

			if (saveUri) {
				await vscode.workspace.fs.writeFile(saveUri, Buffer.from(exportData, 'utf8'));
				vscode.window.showInformationMessage('„Éó„É≠„É≥„Éó„Éà„Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü');
			}
		} catch (error) {
			vscode.window.showErrorMessage('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
		}
	});

	// „Éó„É≠„É≥„Éó„ÉàÈÅ∏ÊäûÊ©üËÉΩ‰ªò„Åç„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç≥„Éû„É≥„Éâ
	const exportDataWithSelectionCommand = vscode.commands.registerCommand('prompt-template-manager.exportDataWithSelection', async () => {
		try {
			const allPrompts = promptManager.getPrompts();
			
			if (allPrompts.length === 0) {
				vscode.window.showInformationMessage('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éó„É≠„É≥„Éó„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
				return;
			}

			// „Éó„É≠„É≥„Éó„ÉàÈÅ∏ÊäûUI
			interface PromptQuickPickItem extends vscode.QuickPickItem {
				prompt: PromptData;
			}

			const promptItems: PromptQuickPickItem[] = allPrompts.map((prompt: PromptData) => ({
				label: prompt.title,
				description: `‰ΩøÁî®ÂõûÊï∞: ${prompt.usageCount}Âõû`,
				detail: prompt.content.length > 100 ? prompt.content.substring(0, 100) + '...' : prompt.content,
				prompt: prompt
			}));

			const selectedItems = await vscode.window.showQuickPick(promptItems, {
				canPickMany: true,
				placeHolder: '„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éó„É≠„É≥„Éó„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàË§áÊï∞ÈÅ∏ÊäûÂèØÔºâ',
				title: '„Éó„É≠„É≥„Éó„Éà„Ç®„ÇØ„Çπ„Éù„Éº„Éà'
			});

			if (!selectedItems || selectedItems.length === 0) {
				return;
			}

			const selectedPrompts = selectedItems.map(item => item.prompt);
			const exportData = await promptManager.exportSelectedPrompts(selectedPrompts);
			
			// „Éï„Ç°„Ç§„É´„Å´‰øùÂ≠ò
			const saveUri = await vscode.window.showSaveDialog({
				defaultUri: vscode.Uri.file(`selected-prompts-${new Date().toISOString().slice(0, 10)}.json`),
				filters: {
					'JSON Files': ['json']
				}
			});

			if (saveUri) {
				await vscode.workspace.fs.writeFile(saveUri, Buffer.from(exportData, 'utf8'));
				vscode.window.showInformationMessage(`${selectedPrompts.length}ÂÄã„ÅÆ„Éó„É≠„É≥„Éó„Éà„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`);
			}
		} catch (error) {
			console.error('ÈÅ∏Êäû„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç®„É©„Éº:', error);
			vscode.window.showErrorMessage('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
		}
	});

	// „Éá„Éº„Çø„Ç§„É≥„Éù„Éº„Éà„Ç≥„Éû„É≥„ÉâÔºàÂæìÊù•ÁâàÔºâ
	const importDataCommand = vscode.commands.registerCommand('prompt-template-manager.importData', async () => {
		try {
			// „Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû
			const openUri = await vscode.window.showOpenDialog({
				canSelectFiles: true,
				canSelectFolders: false,
				canSelectMany: false,
				filters: {
					'JSON Files': ['json']
				}
			});

			if (openUri && openUri[0]) {
				const fileContent = await vscode.workspace.fs.readFile(openUri[0]);
				const jsonData = Buffer.from(fileContent).toString('utf8');
				
				const result = await promptManager.importData(jsonData);
				
				if (result.imported > 0) {
					vscode.window.showInformationMessage(`${result.imported}ÂÄã„ÅÆ„Éó„É≠„É≥„Éó„Éà„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`);
				}
				if (result.errors.length > 0) {
					vscode.window.showWarningMessage(`Ë≠¶Âëä: ${result.errors.join(', ')}`);
				}
			}
		} catch (error) {
			vscode.window.showErrorMessage('„Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
		}
	});

	// Âç≥ÊôÇÂèçÊò†Ê©üËÉΩ‰ªò„Åç„Ç§„É≥„Éù„Éº„Éà„Ç≥„Éû„É≥„Éâ
	const importDataWithRefreshCommand = vscode.commands.registerCommand('prompt-template-manager.importDataWithRefresh', async () => {
		try {
			// „Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû
			const openUri = await vscode.window.showOpenDialog({
				canSelectFiles: true,
				canSelectFolders: false,
				canSelectMany: false,
				filters: {
					'JSON Files': ['json']
				}
			});

			if (openUri && openUri[0]) {
				const fileContent = await vscode.workspace.fs.readFile(openUri[0]);
				const jsonData = Buffer.from(fileContent).toString('utf8');
				
				const result = await promptManager.importData(jsonData);
				
				// ÁµêÊûúË°®Á§∫
				if (result.imported > 0) {
					vscode.window.showInformationMessage(`${result.imported}ÂÄã„ÅÆ„Éó„É≠„É≥„Éó„Éà„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åó„Åü`);
					
					// Âç≥ÊôÇÂèçÊò†: TreeDataProvider„ÇíÊõ¥Êñ∞
					treeDataProvider.refresh();
					
					// „É°„Ç§„É≥„Éë„Éç„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÊõ¥Êñ∞
					if (PromptTemplatePanel.currentPanel) {
						PromptTemplatePanel.currentPanel.refresh();
					}
				} else {
					vscode.window.showInformationMessage('„Ç§„É≥„Éù„Éº„Éà„Åô„Çã„Éó„É≠„É≥„Éó„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
				}
				
				if (result.errors.length > 0) {
					vscode.window.showWarningMessage(`Ë≠¶Âëä: ${result.errors.join(', ')}`);
				}
			}
		} catch (error) {
			console.error('„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº:', error);
			vscode.window.showErrorMessage('„Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
		}
	});

	// „Éó„É≠„É≥„Éó„Éà„ÇíÁõ¥Êé•Èñã„Åè„Ç≥„Éû„É≥„Éâ
	const openPromptCommand = vscode.commands.registerCommand('prompt-template-manager.openPrompt', async (promptId: string) => {
		try {
			// „É°„Ç§„É≥„Éë„Éç„É´„ÇíÈñã„Åè
			PromptTemplatePanel.createOrShow(context.extensionUri, promptManager, variableSettingsProvider);
			
			// ÊåáÂÆö„Åï„Çå„Åü„Éó„É≠„É≥„Éó„Éà„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
			promptManager.setSelectedPrompt(promptId);
			
			// „Éë„Éç„É´„ÇíÊõ¥Êñ∞„Åó„Å¶„Éó„É≠„É≥„Éó„Éà„ÇíË°®Á§∫
			if (PromptTemplatePanel.currentPanel) {
				PromptTemplatePanel.currentPanel.refresh();
			}
		} catch (error) {
			console.error('„Éó„É≠„É≥„Éó„Éà„ÇíÈñã„ÅèÈöõ„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü:', error);
		}
	});

	// Áµ±Ë®àË°®Á§∫„Ç≥„Éû„É≥„Éâ
	const showStatsCommand = vscode.commands.registerCommand('prompt-template-manager.showStats', async () => {
		try {
			const stats = promptManager.getStats();
			const storageInfo = await promptManager.getStorageInfo();
			
			const message = [
				'üìä Prompt Template Manager Áµ±Ë®à',
				'',
				`üìù Á∑è„Éó„É≠„É≥„Éó„ÉàÊï∞: ${stats.totalCount}`,
				`üíæ „Çπ„Éà„É¨„Éº„Ç∏‰ΩøÁî®Èáè: ${storageInfo.storageSize}`,
				stats.mostUsedPrompt ? `‚≠ê ÊúÄÂ§ö‰ΩøÁî®: "${stats.mostUsedPrompt.title}" (${stats.mostUsedPrompt.usageCount}Âõû)` : ''
			].filter(line => line !== '').join('\n');
			
			// Áµ±Ë®àÊÉÖÂ†±„ÅÆË°®Á§∫
		} catch (error) {
			// Áµ±Ë®à„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü
		}
	});

	try {
		context.subscriptions.push(
			openPanelCommand, 
			createPromptCommand, 
			exportDataCommand, 
			exportDataWithSelectionCommand,
			importDataCommand, 
			importDataWithRefreshCommand,
			showStatsCommand,
			openPromptCommand
		);
		console.log('„Åô„Åπ„Å¶„ÅÆ„Ç≥„Éû„É≥„Éâ„ÅåÊ≠£Â∏∏„Å´ÁôªÈå≤„Åï„Çå„Åæ„Åó„Åü');
		console.log('ÁôªÈå≤„Åï„Çå„Åü„Ç≥„Éû„É≥„Éâ:', [
			'prompt-template-manager.openPanel',
			'prompt-template-manager.createPrompt',
			'prompt-template-manager.exportData',
			'prompt-template-manager.exportDataWithSelection',
			'prompt-template-manager.importData',
			'prompt-template-manager.importDataWithRefresh',
			'prompt-template-manager.showStats'
		]);
	} catch (error) {
		console.error('„Ç≥„Éû„É≥„ÉâÁôªÈå≤„Ç®„É©„Éº:', error);
		// „Ç≥„Éû„É≥„Éâ„ÅÆÁôªÈå≤„Å´Â§±Êïó„Åó„Åæ„Åó„Åü
	}
}

// This method is called when your extension is deactivated
export function deactivate() {}

// „Éó„É≠„É≥„Éó„Éà„Éû„Éç„Éº„Ç∏„É£„Éº„ÇØ„É©„Çπ
class PromptManager {
	private context: vscode.ExtensionContext;
	private prompts: PromptData[] = [];
	private storage: PromptStorage;
	private selectedPromptId: string | null = null;
	private currentSearchQuery: string | null = null;
	private currentSearchOptions: any = {};
	private treeDataProvider?: PromptTemplateTreeProvider;

	constructor(context: vscode.ExtensionContext) {
		try {
			console.log('PromptManager „Ç≥„É≥„Çπ„Éà„É©„ÇØ„Çø„ÇíÈñãÂßã');
			this.context = context;
			console.log('ContextË®≠ÂÆöÂÆå‰∫Ü');
			this.storage = new PromptStorage(context);
			console.log('StorageÂàùÊúüÂåñÂÆå‰∫Ü');
			this.loadPrompts();
			console.log('„Éó„É≠„É≥„Éó„ÉàË™≠„ÅøËæº„ÅøÈñãÂßã');
		} catch (error) {
			console.error('PromptManager „Ç≥„É≥„Çπ„Éà„É©„ÇØ„Çø„Ç®„É©„Éº:', error);
			throw error;
		}
	}

	// „Éó„É≠„É≥„Éó„Éà„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø
	private async loadPrompts(): Promise<void> {
		try {
			this.prompts = await this.storage.loadPrompts();
			console.log(`${this.prompts.length}‰ª∂„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`);

			// „Éá„Éº„ÇøÊï¥ÂêàÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
			const integrityErrors = PromptValidator.validateStorageIntegrity(this.prompts);
			if (integrityErrors.length > 0) {
				console.warn('„Éá„Éº„ÇøÊï¥ÂêàÊÄß„ÅÆÂïèÈ°å„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü:', integrityErrors);
				// „Éó„É≠„É≥„Éó„Éà„Éá„Éº„Çø„Å´Êï¥ÂêàÊÄß„ÅÆÂïèÈ°å„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü
			}
		} catch (error) {
			console.error('„Éó„É≠„É≥„Éó„Éà„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
			// „Éó„É≠„É≥„Éó„Éà„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÁ©∫„ÅÆ„É™„Çπ„Éà„ÅßÈñãÂßã„Åó„Åæ„Åô„ÄÇ
			this.prompts = [];
		}
	}

	// „Éó„É≠„É≥„Éó„Éà„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò
	private async savePrompts(): Promise<boolean> {
		return await this.storage.savePrompts(this.prompts);
	}

	// ÈÅ∏Êäû‰∏≠„Éó„É≠„É≥„Éó„Éà„ÇíË®≠ÂÆö
	setSelectedPrompt(promptId: string | null): void {
		this.selectedPromptId = promptId;
	}

	// ÊåáÂÆö„Åó„Åü„Éó„É≠„É≥„Éó„Éà„ÅåÈÅ∏Êäû‰∏≠„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö
	isSelectedPrompt(promptId: string): boolean {
		return this.selectedPromptId === promptId;
	}

	// ÈÅ∏Êäû‰∏≠„Éó„É≠„É≥„Éó„ÉàID„ÇíÂèñÂæó
	getSelectedPromptId(): string | null {
		return this.selectedPromptId;
	}

	// TreeDataProvider„ÇíË®≠ÂÆö
	setTreeDataProvider(provider: PromptTemplateTreeProvider): void {
		this.treeDataProvider = provider;
	}



	// Ê§úÁ¥¢Áä∂ÊÖã„ÇíË®≠ÂÆö
	setSearchState(query: string | null, options: any = {}): void {
		this.currentSearchQuery = query;
		this.currentSearchOptions = options;
	}

	// Ê§úÁ¥¢Áä∂ÊÖã„Çí„ÇØ„É™„Ç¢
	clearSearchState(): void {
		this.currentSearchQuery = null;
		this.currentSearchOptions = {};
	}

	// Ê§úÁ¥¢‰∏≠„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö
	isSearching(): boolean {
		return this.currentSearchQuery !== null;
	}

	// ÁèæÂú®„ÅÆË°®Á§∫Áî®„Éó„É≠„É≥„Éó„Éà‰∏ÄË¶ß„ÇíÂèñÂæóÔºàÊ§úÁ¥¢Áä∂ÊÖã„ÇíËÄÉÊÖÆÔºâ
	getCurrentDisplayPrompts(): PromptData[] {
		if (this.isSearching()) {
			return this.advancedSearch(this.currentSearchQuery!, this.currentSearchOptions);
		}
		return this.getPrompts();
	}

	// ‰ΩøÁî®ÂõûÊï∞È†Ü„Åß„ÇΩ„Éº„Éà„Åï„Çå„Åü„Éó„É≠„É≥„Éó„Éà‰∏ÄË¶ß„ÇíÂèñÂæóÔºàÈÅ∏Êäû‰∏≠„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíÊúÄ‰∏ä‰Ωç„Å´Ôºâ
	getPrompts(): PromptData[] {
		const filteredPrompts = this.prompts.filter(prompt => !prompt.isArchived);
		
		// ÈÅ∏Êäû‰∏≠„ÅÆ„Éó„É≠„É≥„Éó„Éà„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂæìÊù•ÈÄö„Çä„ÅÆ‰ΩøÁî®ÂõûÊï∞ÈôçÈ†Ü
		if (!this.selectedPromptId) {
			return filteredPrompts.sort((a, b) => b.usageCount - a.usageCount);
		}
		
		// ÈÅ∏Êäû‰∏≠„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíÊúÄ‰∏ä‰Ωç„Å´„ÄÅ„Åù„ÅÆ‰ªñ„ÅØ‰ΩøÁî®ÂõûÊï∞ÈôçÈ†Ü„Åß„ÇΩ„Éº„Éà
		return filteredPrompts.sort((a, b) => {
			// ÈÅ∏Êäû‰∏≠„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíÊúÄÂÑ™ÂÖà
			if (a.id === this.selectedPromptId && b.id !== this.selectedPromptId) {
				return -1;
			}
			if (b.id === this.selectedPromptId && a.id !== this.selectedPromptId) {
				return 1;
			}
			
			// ‰∏°Êñπ„Å®„ÇÇÈÅ∏Êäû‰∏≠„Åß„Å™„ÅÑÂ†¥Âêà„ÄÅ„Åæ„Åü„ÅØ‰∏°Êñπ„Å®„ÇÇÈÅ∏Êäû‰∏≠„ÅÆÂ†¥Âêà„ÅØ‰ΩøÁî®ÂõûÊï∞„ÅßÊØîËºÉ
			return b.usageCount - a.usageCount;
		});
	}

	// „Éó„É≠„É≥„Éó„Éà„ÇíËøΩÂä†
	async addPrompt(input: PromptInput): Promise<PromptData | null> {
		console.log('addPrompt „É°„ÇΩ„ÉÉ„Éâ„ÅåÂëº„Å≥Âá∫„Åï„Çå„Åæ„Åó„Åü:', input);
		const errors = PromptValidator.validatePromptInput(input, this.prompts);
		if (errors.length > 0) {
			console.error('ÂÖ•Âäõ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥„Ç®„É©„Éº:', errors);
			return null;
		}

		const newPrompt = PromptUtils.createPromptData(input);
		this.prompts.push(newPrompt);
		
		try {
			const saved = await this.savePrompts();
			if (saved) {
				console.log(`„Éó„É≠„É≥„Éó„Éà "${newPrompt.title}" „ÅåÊ≠£Â∏∏„Å´‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü`);
				return newPrompt;
			} else {
				// ‰øùÂ≠ò„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØ„É°„É¢„É™„Åã„Çâ„ÇÇÂâäÈô§
				this.prompts.pop();
				// „Éó„É≠„É≥„Éó„Éà„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæå„Å´ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
				return null;
			}
		} catch (error) {
			// ‰øùÂ≠ò‰∏≠„Å´‰æãÂ§ñ„ÅåÁô∫Áîü„Åó„ÅüÂ†¥Âêà
			this.prompts.pop();
			console.error('„Éó„É≠„É≥„Éó„Éà‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü:', error);
			// „Éó„É≠„É≥„Éó„Éà„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü
			return null;
		}
	}

	// „Éó„É≠„É≥„Éó„Éà„ÇíÁ∑®ÈõÜ
	async updatePrompt(id: string, updates: Partial<{ title: string; content: string }>): Promise<boolean> {
		const prompt = this.prompts.find(p => p.id === id);
		if (!prompt) {
			console.error(`Êõ¥Êñ∞ÂØæË±°„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ID=${id}`);
			return false;
		}

		// Êõ¥Êñ∞Ââç„ÅÆÂÄ§„Çí‰øùÂ≠ò
		const oldTitle = prompt.title;
		const oldContent = prompt.content;

		try {
			// Êõ¥Êñ∞„ÇíÈÅ©Áî®
			if (updates.title !== undefined) {
				prompt.title = updates.title;
			}
			if (updates.content !== undefined) {
				prompt.content = updates.content;
			}

			// ‰øùÂ≠ò
			const saved = await this.savePrompts();
			if (saved) {
				console.log(`„Éó„É≠„É≥„Éó„Éà "${prompt.title}" „ÅåÊ≠£Â∏∏„Å´Êõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü`);
				return true;
			} else {
				// ‰øùÂ≠ò„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØÂÖÉ„Å´Êàª„Åô
				prompt.title = oldTitle;
				prompt.content = oldContent;
				console.error(`„Éó„É≠„É≥„Éó„ÉàÊõ¥Êñ∞„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó: ID=${id}`);
				return false;
			}
		} catch (error) {
			// ‰æãÂ§ñ„ÅåÁô∫Áîü„Åó„ÅüÂ†¥Âêà„ÅØÂÖÉ„Å´Êàª„Åô
			prompt.title = oldTitle;
			prompt.content = oldContent;
			console.error(`„Éó„É≠„É≥„Éó„ÉàÊõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü: ID=${id}`, error);
			return false;
		}
	}

	// „Éó„É≠„É≥„Éó„Éà„ÇíÂâäÈô§
	async deletePrompt(id: string): Promise<boolean> {
		const index = this.prompts.findIndex(p => p.id === id);
		if (index !== -1) {
			const removedPrompt = this.prompts.splice(index, 1)[0];
			
			try {
				const saved = await this.savePrompts();
				if (saved) {
					console.log(`„Éó„É≠„É≥„Éó„Éà "${removedPrompt.title}" „ÅåÊ≠£Â∏∏„Å´ÂâäÈô§„Åï„Çå„Åæ„Åó„Åü`);
					return true;
				} else {
					// ‰øùÂ≠ò„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØÂÖÉ„Å´Êàª„Åô
					this.prompts.splice(index, 0, removedPrompt);
					// „Éó„É≠„É≥„Éó„Éà„ÅÆÂâäÈô§‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÂæå„Å´ÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
					return false;
				}
			} catch (error) {
				// ‰øùÂ≠ò‰∏≠„Å´‰æãÂ§ñ„ÅåÁô∫Áîü„Åó„ÅüÂ†¥Âêà„ÅØÂÖÉ„Å´Êàª„Åô
				this.prompts.splice(index, 0, removedPrompt);
				console.error('„Éó„É≠„É≥„Éó„ÉàÂâäÈô§‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü:', error);
				// „Éó„É≠„É≥„Éó„Éà„ÅÆÂâäÈô§‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü
				return false;
			}
		}
		return false;
	}

	// ‰ΩøÁî®ÂõûÊï∞„ÇíÂ¢óÂä†
	async incrementUsage(id: string): Promise<boolean> {
		console.log(`‰ΩøÁî®ÂõûÊï∞Â¢óÂä†Ë©¶Ë°å: ID=${id}`);
		const prompt = this.prompts.find(p => p.id === id);
		if (prompt) {
			const oldCount = prompt.usageCount;
			prompt.usageCount++;
			console.log(`‰ΩøÁî®ÂõûÊï∞Êõ¥Êñ∞: "${prompt.title}" ${oldCount} -> ${prompt.usageCount}`);
			
			try {
				const saved = await this.savePrompts();
				if (saved) {
					console.log(`‰ΩøÁî®ÂõûÊï∞‰øùÂ≠òÊàêÂäü: "${prompt.title}"`);
					return true;
				} else {
					// ‰øùÂ≠ò„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØÂÖÉ„Å´Êàª„Åô
					prompt.usageCount = oldCount;
					console.error(`‰ΩøÁî®ÂõûÊï∞‰øùÂ≠òÂ§±Êïó: "${prompt.title}"`);
					return false;
				}
			} catch (error) {
				// ‰øùÂ≠ò‰∏≠„Å´‰æãÂ§ñ„ÅåÁô∫Áîü„Åó„ÅüÂ†¥Âêà„ÅØÂÖÉ„Å´Êàª„Åô
				prompt.usageCount = oldCount;
				console.error(`‰ΩøÁî®ÂõûÊï∞‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº: "${prompt.title}"`, error);
				return false;
			}
		} else {
			console.error(`„Éó„É≠„É≥„Éó„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ID=${id}`);
			console.log('Â≠òÂú®„Åô„Çã„Éó„É≠„É≥„Éó„ÉàID‰∏ÄË¶ß:', this.prompts.map(p => p.id));
			return false;
		}
	}

	// „Éó„É≠„É≥„Éó„Éà„ÇíÊ§úÁ¥¢
	searchPrompts(query: string): PromptData[] {
		return this.getPrompts().filter(prompt => 
			PromptUtils.matchesSearchQuery(prompt, query)
		);
	}

	// È´òÂ∫¶„Å™Ê§úÁ¥¢Ê©üËÉΩ
	advancedSearch(query: string, options: any = {}): PromptData[] {
		// „Éï„Ç£„É´„Çø„É™„É≥„Ç∞Áî®„ÅÆÂÖ®„Éó„É≠„É≥„Éó„Éà„ÇíÂèñÂæóÔºàÈÅ∏ÊäûÁä∂ÊÖã„ÅÆ„ÇΩ„Éº„Éà„Å™„ÅóÔºâ
		let results = this.prompts
			.filter(prompt => !prompt.isArchived)
			.sort((a, b) => b.usageCount - a.usageCount);

		// „ÉÜ„Ç≠„Çπ„ÉàÊ§úÁ¥¢
		if (query && query.trim().length > 0) {
			results = results.filter(prompt => 
				PromptUtils.matchesSearchQuery(prompt, query)
			);
		}

		// „ÅäÊ∞ó„Å´ÂÖ•„Çä„Éï„Ç£„É´„Çø
		if (options.favoritesOnly) {
			results = results.filter(prompt => prompt.isFavorite);
		}

		// ÂÑ™ÂÖàÂ∫¶„Éï„Ç£„É´„Çø
		if (options.priority && options.priority > 0) {
			results = results.filter(prompt => prompt.priority === options.priority);
		}

		// ‰ΩøÁî®ÂõûÊï∞„Éï„Ç£„É´„Çø
		if (options.minUsageCount !== undefined) {
			results = results.filter(prompt => prompt.usageCount >= options.minUsageCount);
		}

		// Ê§úÁ¥¢ÁµêÊûú„Åß„ÇÇÈÅ∏Êäû‰∏≠„Éó„É≠„É≥„Éó„Éà„ÇíÊúÄ‰∏ä‰Ωç„Å´
		if (this.selectedPromptId) {
			results = results.sort((a, b) => {
				// ÈÅ∏Êäû‰∏≠„ÅÆ„Éó„É≠„É≥„Éó„Éà„ÇíÊúÄÂÑ™ÂÖà
				if (a.id === this.selectedPromptId && b.id !== this.selectedPromptId) {
					return -1;
				}
				if (b.id === this.selectedPromptId && a.id !== this.selectedPromptId) {
					return 1;
				}
				
				// ‰∏°Êñπ„Å®„ÇÇÈÅ∏Êäû‰∏≠„Åß„Å™„ÅÑÂ†¥Âêà„ÄÅ„Åæ„Åü„ÅØ‰∏°Êñπ„Å®„ÇÇÈÅ∏Êäû‰∏≠„ÅÆÂ†¥Âêà„ÅØ‰ΩøÁî®ÂõûÊï∞„ÅßÊØîËºÉ
				return b.usageCount - a.usageCount;
			});
		}

		console.log(`Ê§úÁ¥¢ÁµêÊûú: ${results.length}‰ª∂`);
		return results;
	}



	// „Éó„É≠„É≥„Éó„Éà„Çí„Ç¢„Éº„Ç´„Ç§„Éñ/Âæ©ÂÖÉ
	async toggleArchive(id: string): Promise<boolean> {
		const prompt = this.prompts.find(p => p.id === id);
		if (prompt) {
			prompt.isArchived = !prompt.isArchived;
			return await this.savePrompts();
		}
		return false;
	}

	// „Éá„Éº„Çø„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà
	async exportData(): Promise<string> {
		try {
			const exportData = await this.storage.exportData(this.prompts);
			return JSON.stringify(exportData, null, 2);
		} catch (error) {
			console.error('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó:', error);
			throw new Error('„Éá„Éº„Çø„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
		}
	}

	// ÈÅ∏Êäû„Åï„Çå„Åü„Éó„É≠„É≥„Éó„Éà„Çí„Ç®„ÇØ„Çπ„Éù„Éº„Éà
	async exportSelectedPrompts(selectedPrompts: PromptData[]): Promise<string> {
		try {
			const exportData = await this.storage.exportData(selectedPrompts);
			return JSON.stringify(exportData, null, 2);
		} catch (error) {
			console.error('ÈÅ∏Êäû„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó:', error);
			throw new Error('ÈÅ∏Êäû„Åï„Çå„Åü„Éó„É≠„É≥„Éó„Éà„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
		}
	}

	// „Éá„Éº„Çø„Çí„Ç§„É≥„Éù„Éº„Éà
	async importData(jsonData: string): Promise<{ imported: number; errors: string[] }> {
		try {
			// JSON„ÅÆËß£Êûê
			let exportData: any;
			try {
				exportData = JSON.parse(jsonData);
			} catch (parseError) {
				return { imported: 0, errors: ['‰∏çÊ≠£„Å™JSONÂΩ¢Âºè„Åß„Åô'] };
			}

			// „Éá„Éº„ÇøÂΩ¢Âºè„ÅÆÊ§úË®º
			const validationErrors = PromptValidator.validateImportData(exportData);
			if (validationErrors.length > 0) {
				const errorMessages = validationErrors.map(e => e.message);
				return { imported: 0, errors: errorMessages };
			}

			// „Ç§„É≥„Éù„Éº„ÉàÂá¶ÁêÜ
			const importedPrompts = await this.storage.importData(exportData);
			
			// „Çø„Ç§„Éà„É´ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
			const duplicates: string[] = [];
			const validPrompts: PromptData[] = [];
			
			importedPrompts.forEach(prompt => {
				const existingPrompt = this.prompts.find(p => 
					p.title.toLowerCase() === prompt.title.toLowerCase()
				);
				if (existingPrompt) {
					duplicates.push(prompt.title);
				} else {
					validPrompts.push(prompt);
				}
			});

			// ÊúâÂäπ„Å™„Éó„É≠„É≥„Éó„Éà„ÅÆ„ÅøËøΩÂä†
			this.prompts.push(...validPrompts);
			
			// „Éá„Éº„ÇøÊï¥ÂêàÊÄß„ÅÆÊ§úË®º
			const integrityErrors = PromptValidator.validateStorageIntegrity(this.prompts);
			if (integrityErrors.length > 0) {
				// ËøΩÂä†„Åó„Åü„Éó„É≠„É≥„Éó„Éà„ÇíÂâäÈô§„Åó„Å¶„É≠„Éº„É´„Éê„ÉÉ„ÇØ
				this.prompts.splice(-validPrompts.length);
				return { imported: 0, errors: ['„Éá„Éº„Çø„ÅÆÊï¥ÂêàÊÄß„Ç®„É©„Éº„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü'] };
			}

			// ‰øùÂ≠ò
			try {
				const saved = await this.savePrompts();
				if (saved) {
					const result = { imported: validPrompts.length, errors: [] as string[] };
					if (duplicates.length > 0) {
						result.errors.push(`ÈáçË§á„Çπ„Ç≠„ÉÉ„Éó: ${duplicates.join(', ')}`);
					}
					return result;
				} else {
					// ‰øùÂ≠ò„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØËøΩÂä†„Åó„Åü„Éó„É≠„É≥„Éó„Éà„ÇíÂâäÈô§
					this.prompts.splice(-validPrompts.length);
					return { imported: 0, errors: ['„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü'] };
				}
			} catch (saveError) {
				// ‰øùÂ≠ò„Å´Â§±Êïó„Åó„ÅüÂ†¥Âêà„ÅØËøΩÂä†„Åó„Åü„Éó„É≠„É≥„Éó„Éà„ÇíÂâäÈô§
				this.prompts.splice(-validPrompts.length);
				console.error('„Ç§„É≥„Éù„Éº„Éà„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó:', saveError);
				return { imported: 0, errors: [`‰øùÂ≠ò„Ç®„É©„Éº: ${(saveError as Error).message}`] };
			}
		} catch (error) {
			console.error('„Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó:', error);
			return { imported: 0, errors: [(error as Error).message] };
		}
	}

	// „Çπ„Éà„É¨„Éº„Ç∏ÊÉÖÂ†±„ÇíÂèñÂæó
	async getStorageInfo() {
		return await this.storage.getStorageInfo();
	}

	// Áµ±Ë®àÊÉÖÂ†±„ÇíÂèñÂæó
	getStats() {
		const totalCount = this.prompts.filter(p => !p.isArchived).length;

		// ÊúÄ„ÇÇ‰ΩøÁî®È†ªÂ∫¶„ÅÆÈ´ò„ÅÑ„Éó„É≠„É≥„Éó„Éà
		const mostUsedPrompt = this.prompts
			.filter(p => !p.isArchived)
			.sort((a, b) => b.usageCount - a.usageCount)[0];

		return {
			totalCount,
			todayCreated: 0, // ‰ΩúÊàêÊó•„Åå„Å™„ÅÑ„Åü„ÇÅ0Âõ∫ÂÆö
			weeklyUsage: 0, // Êõ¥Êñ∞Êó•„Åå„Å™„ÅÑ„Åü„ÇÅ0Âõ∫ÂÆö
			mostUsedPrompt
		};
	}
}
